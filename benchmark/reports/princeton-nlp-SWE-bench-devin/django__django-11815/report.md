# django__django-11815

| **django/django** | `e02f67ef2d03d48128e7a118bf75f0418e24e8ac` |
| ---- | ---- |
| **No of patches** | 1 |
| **All found context length** | 155 |
| **Any found context length** | 155 |
| **Avg pos** | 1.0 |
| **Min pos** | 1 |
| **Max pos** | 1 |
| **Top file pos** | 1 |
| **Missing snippets** | 1 |
| **Missing patch files** | 0 |


## Expected patch

```diff
diff --git a/django/db/migrations/serializer.py b/django/db/migrations/serializer.py
--- a/django/db/migrations/serializer.py
+++ b/django/db/migrations/serializer.py
@@ -120,9 +120,10 @@ class EnumSerializer(BaseSerializer):
     def serialize(self):
         enum_class = self.value.__class__
         module = enum_class.__module__
-        v_string, v_imports = serializer_factory(self.value.value).serialize()
-        imports = {'import %s' % module, *v_imports}
-        return "%s.%s(%s)" % (module, enum_class.__name__, v_string), imports
+        return (
+            '%s.%s[%r]' % (module, enum_class.__name__, self.value.name),
+            {'import %s' % module},
+        )
 
 
 class FloatSerializer(BaseSimpleSerializer):

```

## Expected file changes

| File | Start line | End line | Found on position | Found file position | Context length |
| ---- | ---------- | -------- | ----------------- | ------------------- | -------------- |
| django/db/migrations/serializer.py | 123 | 125 | 1 | 1 | 155


## Problem Statement

```
Migrations uses value of enum object instead of its name.
Description
	 
		(last modified by oasl)
	 
When using Enum object as a default value for a CharField, the generated migration file uses the value of the Enum object instead of the its name. This causes a problem when using Django translation on the value of the Enum object. 
The problem is that, when the Enum object value get translated to the users language, the old migration files raise an error stating that the Enum does not have the corresponding value. (because the Enum value is translated to another language)
Example:
Let say we have this code in models.py:
from enum import Enum
from django.utils.translation import gettext_lazy as _
from django.db import models
class Status(Enum):
	GOOD = _('Good') # 'Good' will be translated
	BAD = _('Bad') # 'Bad' will be translated
	def __str__(self):
		return self.name
class Item(models.Model):
	status = models.CharField(default=Status.GOOD, max_length=128)
In the generated migration file, the code will be:
...
('status', models.CharField(default=Status('Good'), max_length=128))
...
After the translation, 'Good' will be translated to another word and it will not be part of the Status Enum class any more, so the migration file will raise the error on the previous line:
ValueError: 'Good' is not a valid Status
Shouldn't the code generated by the migration uses the name of the Status Enum 'GOOD', not the value of it, since it is changeable?
It should be:
('status', models.CharField(default=Status['GOOD'], max_length=128))
This will be correct regardless of the translated word

```

## Retrieved code snippets

| Position | File | Start line | End line | Tokens | Sum tokens | File tokens |
| -------- | ---- | ---------- | -------- | ------ | ---------- | ----------- |
| **-> 1 <-** | **1 django/db/migrations/serializer.py** | 119 | 137| 155 | 155 | 2567 | 
| 2 | 2 django/db/migrations/exceptions.py | 1 | 55| 250 | 405 | 2818 | 
| 3 | 3 django/contrib/auth/migrations/0004_alter_user_username_opts.py | 1 | 24| 150 | 555 | 2968 | 
| 4 | 4 django/contrib/auth/migrations/0007_alter_validators_add_error_messages.py | 1 | 25| 137 | 692 | 3105 | 
| 5 | 5 django/db/migrations/state.py | 580 | 599| 188 | 880 | 8323 | 
| 6 | 6 django/contrib/auth/migrations/0001_initial.py | 1 | 105| 849 | 1729 | 9172 | 
| 7 | 7 django/db/migrations/questioner.py | 162 | 185| 246 | 1975 | 11246 | 
| 8 | 8 django/db/models/enums.py | 36 | 76| 259 | 2234 | 11787 | 
| 9 | 9 django/db/models/options.py | 316 | 336| 158 | 2392 | 18886 | 
| 10 | 9 django/db/migrations/questioner.py | 227 | 240| 123 | 2515 | 18886 | 
| 11 | 10 django/db/migrations/migration.py | 1 | 88| 714 | 3229 | 20519 | 
| 12 | 10 django/db/models/enums.py | 1 | 34| 288 | 3517 | 20519 | 
| 13 | 10 django/db/migrations/migration.py | 127 | 194| 585 | 4102 | 20519 | 
| 14 | 10 django/db/migrations/questioner.py | 187 | 205| 237 | 4339 | 20519 | 
| 15 | 11 django/contrib/auth/migrations/0008_alter_user_username_max_length.py | 1 | 25| 138 | 4477 | 20657 | 
| 16 | 11 django/db/migrations/questioner.py | 56 | 81| 220 | 4697 | 20657 | 
| 17 | 11 django/db/migrations/questioner.py | 109 | 141| 290 | 4987 | 20657 | 
| 18 | 12 django/db/migrations/operations/models.py | 345 | 394| 493 | 5480 | 27353 | 
| 19 | 13 django/contrib/admin/migrations/0001_initial.py | 1 | 48| 322 | 5802 | 27675 | 
| 20 | 14 django/db/backends/mysql/schema.py | 122 | 140| 192 | 5994 | 29070 | 
| 21 | 14 django/db/migrations/state.py | 496 | 528| 250 | 6244 | 29070 | 
| 22 | 14 django/db/migrations/operations/models.py | 304 | 343| 406 | 6650 | 29070 | 
| 23 | 14 django/db/models/options.py | 338 | 361| 198 | 6848 | 29070 | 
| 24 | 15 django/db/migrations/operations/fields.py | 357 | 384| 289 | 7137 | 32337 | 
| 25 | 16 django/core/management/commands/migrate.py | 342 | 365| 180 | 7317 | 35489 | 
| 26 | 16 django/db/migrations/state.py | 601 | 612| 136 | 7453 | 35489 | 
| 27 | 17 django/db/migrations/operations/base.py | 1 | 102| 783 | 8236 | 36568 | 
| 28 | 18 django/contrib/gis/db/models/functions.py | 88 | 119| 231 | 8467 | 40367 | 
| 29 | 18 django/db/migrations/operations/fields.py | 302 | 355| 535 | 9002 | 40367 | 
| 30 | 19 django/utils/translation/trans_null.py | 1 | 68| 269 | 9271 | 40636 | 
| 31 | 20 django/contrib/sites/migrations/0001_initial.py | 1 | 32| 192 | 9463 | 40828 | 
| 32 | 21 django/contrib/contenttypes/migrations/0002_remove_content_type_name.py | 1 | 40| 217 | 9680 | 41045 | 
| 33 | 22 django/db/migrations/autodetector.py | 1178 | 1203| 245 | 9925 | 52738 | 
| 34 | 22 django/db/migrations/operations/models.py | 625 | 677| 342 | 10267 | 52738 | 
| 35 | 22 django/core/management/commands/migrate.py | 259 | 291| 349 | 10616 | 52738 | 
| 36 | 22 django/db/migrations/state.py | 349 | 399| 471 | 11087 | 52738 | 
| 37 | 22 django/db/migrations/operations/models.py | 460 | 485| 279 | 11366 | 52738 | 
| 38 | 23 django/utils/translation/__init__.py | 197 | 269| 440 | 11806 | 55064 | 
| 39 | 23 django/db/migrations/autodetector.py | 437 | 463| 256 | 12062 | 55064 | 
| 40 | 23 django/db/migrations/operations/models.py | 396 | 412| 182 | 12244 | 55064 | 
| 41 | 24 django/db/backends/sqlite3/schema.py | 101 | 138| 486 | 12730 | 59029 | 
| 42 | 24 django/db/migrations/operations/models.py | 609 | 622| 137 | 12867 | 59029 | 
| 43 | 24 django/db/migrations/operations/models.py | 566 | 589| 183 | 13050 | 59029 | 
| 44 | 25 django/db/migrations/writer.py | 118 | 199| 744 | 13794 | 61276 | 
| 45 | 25 django/db/backends/mysql/schema.py | 1 | 77| 751 | 14545 | 61276 | 
| 46 | 25 django/utils/translation/__init__.py | 68 | 147| 489 | 15034 | 61276 | 
| 47 | 26 django/forms/fields.py | 1171 | 1201| 182 | 15216 | 70200 | 
| 48 | 27 django/db/backends/base/operations.py | 464 | 481| 163 | 15379 | 75673 | 
| 49 | 28 django/contrib/admin/migrations/0003_logentry_add_action_flag_choices.py | 1 | 21| 111 | 15490 | 75784 | 
| 50 | 29 django/db/models/lookups.py | 553 | 565| 124 | 15614 | 80350 | 
| 51 | 30 django/db/models/fields/__init__.py | 1755 | 1800| 279 | 15893 | 97757 | 
| 52 | 30 django/utils/translation/__init__.py | 55 | 65| 127 | 16020 | 97757 | 
| 53 | 30 django/db/models/options.py | 149 | 208| 587 | 16607 | 97757 | 
| 54 | 30 django/db/migrations/autodetector.py | 1293 | 1324| 314 | 16921 | 97757 | 
| 55 | 30 django/db/migrations/operations/models.py | 591 | 607| 215 | 17136 | 97757 | 
| 56 | 31 django/contrib/auth/migrations/0010_alter_group_name_max_length.py | 1 | 17| 0 | 17136 | 97834 | 
| 57 | 31 django/db/models/fields/__init__.py | 1031 | 1044| 104 | 17240 | 97834 | 
| 58 | 32 django/contrib/gis/gdal/geomtype.py | 1 | 96| 757 | 17997 | 98592 | 
| 59 | **32 django/db/migrations/serializer.py** | 257 | 276| 155 | 18152 | 98592 | 
| 60 | 33 django/db/models/base.py | 1759 | 1830| 565 | 18717 | 113881 | 
| 61 | 33 django/db/migrations/autodetector.py | 1142 | 1176| 296 | 19013 | 113881 | 
| 62 | 34 django/db/backends/base/schema.py | 255 | 276| 154 | 19167 | 125197 | 
| 63 | 35 django/db/migrations/recorder.py | 1 | 22| 153 | 19320 | 125867 | 
| 64 | 36 django/db/migrations/executor.py | 281 | 296| 165 | 19485 | 129159 | 
| 65 | 36 django/db/migrations/autodetector.py | 904 | 981| 834 | 20319 | 129159 | 
| 66 | 36 django/core/management/commands/migrate.py | 67 | 160| 825 | 21144 | 129159 | 
| 67 | 36 django/db/migrations/autodetector.py | 1082 | 1117| 312 | 21456 | 129159 | 
| 68 | 36 django/db/migrations/operations/fields.py | 220 | 239| 205 | 21661 | 129159 | 
| 69 | 37 django/contrib/humanize/templatetags/humanize.py | 82 | 128| 578 | 22239 | 132319 | 
| 70 | 38 django/db/migrations/loader.py | 148 | 174| 291 | 22530 | 135236 | 
| 71 | **38 django/db/migrations/serializer.py** | 1 | 73| 428 | 22958 | 135236 | 
| 72 | 39 django/core/management/commands/makemigrations.py | 147 | 184| 302 | 23260 | 137985 | 
| 73 | 39 django/db/migrations/operations/models.py | 1 | 38| 238 | 23498 | 137985 | 
| 74 | 39 django/db/backends/sqlite3/schema.py | 39 | 65| 243 | 23741 | 137985 | 
| 75 | 39 django/db/models/base.py | 1443 | 1466| 176 | 23917 | 137985 | 
| 76 | 39 django/db/migrations/operations/base.py | 104 | 142| 299 | 24216 | 137985 | 
| 77 | 40 django/db/models/functions/text.py | 58 | 77| 153 | 24369 | 140441 | 
| 78 | 40 django/db/migrations/operations/fields.py | 241 | 251| 146 | 24515 | 140441 | 
| 79 | 40 django/db/migrations/autodetector.py | 337 | 356| 196 | 24711 | 140441 | 
| 80 | 41 django/utils/translation/trans_real.py | 154 | 167| 154 | 24865 | 144270 | 
| 81 | 42 django/contrib/admin/widgets.py | 352 | 378| 328 | 25193 | 148136 | 
| 82 | 43 django/contrib/contenttypes/migrations/0001_initial.py | 1 | 35| 207 | 25400 | 148343 | 
| 83 | 43 django/core/management/commands/makemigrations.py | 60 | 146| 788 | 26188 | 148343 | 
| 84 | 43 django/contrib/gis/db/models/functions.py | 439 | 467| 225 | 26413 | 148343 | 
| 85 | 44 django/contrib/flatpages/migrations/0001_initial.py | 1 | 40| 308 | 26721 | 148651 | 
| 86 | 44 django/db/backends/base/schema.py | 626 | 698| 792 | 27513 | 148651 | 
| 87 | 45 django/contrib/gis/utils/layermapping.py | 47 | 82| 410 | 27923 | 154077 | 
| 88 | 45 django/db/migrations/questioner.py | 143 | 160| 183 | 28106 | 154077 | 
| 89 | 46 django/db/backends/oracle/schema.py | 125 | 173| 419 | 28525 | 155833 | 
| 90 | 47 django/conf/global_settings.py | 51 | 144| 1087 | 29612 | 161461 | 
| 91 | 47 django/db/migrations/questioner.py | 84 | 107| 187 | 29799 | 161461 | 
| 92 | 47 django/db/migrations/questioner.py | 1 | 54| 468 | 30267 | 161461 | 
| 93 | 47 django/db/migrations/operations/fields.py | 274 | 300| 158 | 30425 | 161461 | 
| 94 | 47 django/db/backends/oracle/schema.py | 79 | 123| 583 | 31008 | 161461 | 
| 95 | 47 django/db/migrations/loader.py | 277 | 301| 205 | 31213 | 161461 | 
| 96 | 48 django/contrib/sessions/migrations/0001_initial.py | 1 | 31| 162 | 31375 | 161623 | 
| 97 | 48 django/db/models/fields/__init__.py | 1701 | 1724| 146 | 31521 | 161623 | 
| 98 | 48 django/db/models/fields/__init__.py | 2264 | 2314| 339 | 31860 | 161623 | 
| 99 | 49 django/db/backends/mysql/operations.py | 1 | 33| 254 | 32114 | 164750 | 
| 100 | 49 django/db/migrations/executor.py | 298 | 377| 712 | 32826 | 164750 | 
| 101 | 49 django/db/backends/sqlite3/schema.py | 86 | 99| 181 | 33007 | 164750 | 
| 102 | 50 django/utils/encoding.py | 48 | 67| 156 | 33163 | 167110 | 
| 103 | 50 django/utils/translation/trans_real.py | 274 | 297| 180 | 33343 | 167110 | 
| 104 | 50 django/db/migrations/autodetector.py | 465 | 506| 418 | 33761 | 167110 | 
| 105 | **50 django/db/migrations/serializer.py** | 106 | 116| 114 | 33875 | 167110 | 
| 106 | 50 django/db/models/options.py | 210 | 260| 446 | 34321 | 167110 | 
| 107 | 50 django/db/migrations/autodetector.py | 1 | 15| 110 | 34431 | 167110 | 
| 108 | 50 django/db/backends/base/operations.py | 483 | 524| 284 | 34715 | 167110 | 
| 109 | 50 django/db/migrations/autodetector.py | 1023 | 1039| 188 | 34903 | 167110 | 
| 110 | 50 django/db/migrations/autodetector.py | 1205 | 1217| 131 | 35034 | 167110 | 
| 111 | 50 django/utils/translation/__init__.py | 150 | 194| 335 | 35369 | 167110 | 
| 112 | 50 django/db/migrations/autodetector.py | 1119 | 1140| 231 | 35600 | 167110 | 
| 113 | 50 django/db/models/fields/__init__.py | 1661 | 1698| 226 | 35826 | 167110 | 
| 114 | 50 django/core/management/commands/migrate.py | 161 | 242| 793 | 36619 | 167110 | 
| 115 | **50 django/db/migrations/serializer.py** | 279 | 310| 270 | 36889 | 167110 | 
| 116 | 50 django/db/backends/base/schema.py | 278 | 299| 174 | 37063 | 167110 | 
| 117 | 51 django/contrib/redirects/migrations/0001_initial.py | 1 | 41| 275 | 37338 | 167385 | 
| 118 | 52 django/contrib/auth/migrations/0002_alter_permission_name_max_length.py | 1 | 17| 0 | 37338 | 167453 | 
| 119 | 52 django/db/migrations/executor.py | 255 | 279| 227 | 37565 | 167453 | 
| 120 | 52 django/utils/translation/__init__.py | 1 | 37| 289 | 37854 | 167453 | 
| 121 | 53 django/contrib/auth/migrations/0011_update_proxy_permissions.py | 1 | 50| 421 | 38275 | 167983 | 
| 122 | 54 django/core/serializers/xml_serializer.py | 88 | 109| 192 | 38467 | 171377 | 
| 123 | 55 django/core/checks/translation.py | 1 | 62| 447 | 38914 | 171824 | 
| 124 | 55 django/utils/encoding.py | 102 | 115| 130 | 39044 | 171824 | 
| 125 | 55 django/db/models/fields/__init__.py | 363 | 389| 199 | 39243 | 171824 | 
| 126 | 55 django/db/migrations/writer.py | 201 | 301| 619 | 39862 | 171824 | 
| 127 | 55 django/db/models/fields/__init__.py | 2012 | 2042| 199 | 40061 | 171824 | 
| 128 | 55 django/db/migrations/operations/models.py | 277 | 302| 135 | 40196 | 171824 | 
| 129 | 55 django/db/models/base.py | 1659 | 1757| 717 | 40913 | 171824 | 
| 130 | 56 django/db/backends/postgresql/schema.py | 72 | 133| 447 | 41360 | 173613 | 
| 131 | 57 django/core/management/commands/sqlmigrate.py | 32 | 69| 371 | 41731 | 174245 | 
| 132 | 57 django/db/backends/oracle/schema.py | 57 | 77| 249 | 41980 | 174245 | 
| 133 | 57 django/db/models/options.py | 1 | 36| 304 | 42284 | 174245 | 
| 134 | 58 django/core/serializers/base.py | 232 | 249| 208 | 42492 | 176638 | 
| 135 | 58 django/db/models/fields/__init__.py | 240 | 305| 467 | 42959 | 176638 | 
| 136 | 59 django/template/base.py | 95 | 136| 208 | 43167 | 184478 | 
| 137 | 59 django/db/models/base.py | 1609 | 1657| 348 | 43515 | 184478 | 
| 138 | 60 django/db/models/fields/related.py | 964 | 991| 215 | 43730 | 197990 | 
| 139 | 60 django/db/backends/base/schema.py | 699 | 768| 740 | 44470 | 197990 | 
| 140 | 61 django/core/management/commands/showmigrations.py | 42 | 63| 158 | 44628 | 199176 | 
| 141 | 61 django/contrib/gis/utils/layermapping.py | 343 | 398| 579 | 45207 | 199176 | 


### Hint

```
Thanks for this report, however I'm not sure how translated values can brake migrations. Can you provide a sample project to reproduce this issue? Migrations with translatable strings works fine for me: >>> class TextEnum(enum.Enum): ... C = _('translatable value') ... >>> TextEnum(_('translatable value')) <TextEnum.C: 'translatable value'> >>> TextEnum('translatable value') <TextEnum.C: 'translatable value'>
To experience the bug: In any Django project, set the default value of a CharField as an enum object: class EnumClass(Enum): VALUE = _('Value') where: VALUE: is the constant enum object name 'Value': is the translatable enum object value In the model: field = models.CharField(default=EnumClass.VALUE, max_length=128) then run: python manage.py makemigrations In the generated migration file, you will notice that the default value of the field is set to: EnumClass('Value'), so it calls the enum object by its translatable value not it is constant name. (This is exactly the BUG, you can think of it without even continue) run: python manage.py migrate In the settings.py file: LANGUAGE_CODE = 'fr-FR' # set it to any language code other than English Run the project after generating, translating, and compiling the messages file (see: ​message-files) The project will raise the error: ValueError: 'Value' is not a valid EnumClass , on the generated migration file.
This use case looks quite niche for me, i.e. I would expect to store a unified values (the same for all languages) and translate only labels visible for users, however I agree that we can fix this.
Here is the diff based on the @oasl solution Shouldn't the code generated by the migration uses the name of the Status Enum 'GOOD', not the value of it, since it is changeable? It should be: ('status', models.CharField(default=Status['GOOD'], max_length=128)) diff --git a/django/db/migrations/serializer.py b/django/db/migrations/serializer.py index 27b5cbd379..b00c6f0df2 100644 --- a/django/db/migrations/serializer.py +++ b/django/db/migrations/serializer.py @@ -120,9 +120,9 @@ class EnumSerializer(BaseSerializer): def serialize(self): enum_class = self.value.__class__ module = enum_class.__module__ - v_string, v_imports = serializer_factory(self.value.value).serialize() + _, v_imports = serializer_factory(self.value.value).serialize() imports = {'import %s' % module, *v_imports} - return "%s.%s(%s)" % (module, enum_class.__name__, v_string), imports + return "%s.%s['%s']" % (module, enum_class.__name__, self.value), imports @felixxm, what do you think?
You cannot use a string representation of self.value i.e. 'EnumClass.GOOD', IMO we should use a name property: return "%s.%s[%r]" % (module, enum_class.__name__, self.value.name), imports
```

## Patch

```diff
diff --git a/django/db/migrations/serializer.py b/django/db/migrations/serializer.py
--- a/django/db/migrations/serializer.py
+++ b/django/db/migrations/serializer.py
@@ -120,9 +120,10 @@ class EnumSerializer(BaseSerializer):
     def serialize(self):
         enum_class = self.value.__class__
         module = enum_class.__module__
-        v_string, v_imports = serializer_factory(self.value.value).serialize()
-        imports = {'import %s' % module, *v_imports}
-        return "%s.%s(%s)" % (module, enum_class.__name__, v_string), imports
+        return (
+            '%s.%s[%r]' % (module, enum_class.__name__, self.value.name),
+            {'import %s' % module},
+        )
 
 
 class FloatSerializer(BaseSimpleSerializer):

```

## Test Patch

```diff
diff --git a/tests/migrations/test_writer.py b/tests/migrations/test_writer.py
--- a/tests/migrations/test_writer.py
+++ b/tests/migrations/test_writer.py
@@ -257,6 +257,10 @@ class TextEnum(enum.Enum):
             A = 'a-value'
             B = 'value-b'
 
+        class TextTranslatedEnum(enum.Enum):
+            A = _('a-value')
+            B = _('value-b')
+
         class BinaryEnum(enum.Enum):
             A = b'a-value'
             B = b'value-b'
@@ -267,15 +271,19 @@ class IntEnum(enum.IntEnum):
 
         self.assertSerializedResultEqual(
             TextEnum.A,
-            ("migrations.test_writer.TextEnum('a-value')", {'import migrations.test_writer'})
+            ("migrations.test_writer.TextEnum['A']", {'import migrations.test_writer'})
+        )
+        self.assertSerializedResultEqual(
+            TextTranslatedEnum.A,
+            ("migrations.test_writer.TextTranslatedEnum['A']", {'import migrations.test_writer'})
         )
         self.assertSerializedResultEqual(
             BinaryEnum.A,
-            ("migrations.test_writer.BinaryEnum(b'a-value')", {'import migrations.test_writer'})
+            ("migrations.test_writer.BinaryEnum['A']", {'import migrations.test_writer'})
         )
         self.assertSerializedResultEqual(
             IntEnum.B,
-            ("migrations.test_writer.IntEnum(2)", {'import migrations.test_writer'})
+            ("migrations.test_writer.IntEnum['B']", {'import migrations.test_writer'})
         )
 
         field = models.CharField(default=TextEnum.B, choices=[(m.value, m) for m in TextEnum])
@@ -283,27 +291,39 @@ class IntEnum(enum.IntEnum):
         self.assertEqual(
             string,
             "models.CharField(choices=["
-            "('a-value', migrations.test_writer.TextEnum('a-value')), "
-            "('value-b', migrations.test_writer.TextEnum('value-b'))], "
-            "default=migrations.test_writer.TextEnum('value-b'))"
+            "('a-value', migrations.test_writer.TextEnum['A']), "
+            "('value-b', migrations.test_writer.TextEnum['B'])], "
+            "default=migrations.test_writer.TextEnum['B'])"
+        )
+        field = models.CharField(
+            default=TextTranslatedEnum.A,
+            choices=[(m.value, m) for m in TextTranslatedEnum],
+        )
+        string = MigrationWriter.serialize(field)[0]
+        self.assertEqual(
+            string,
+            "models.CharField(choices=["
+            "('a-value', migrations.test_writer.TextTranslatedEnum['A']), "
+            "('value-b', migrations.test_writer.TextTranslatedEnum['B'])], "
+            "default=migrations.test_writer.TextTranslatedEnum['A'])"
         )
         field = models.CharField(default=BinaryEnum.B, choices=[(m.value, m) for m in BinaryEnum])
         string = MigrationWriter.serialize(field)[0]
         self.assertEqual(
             string,
             "models.CharField(choices=["
-            "(b'a-value', migrations.test_writer.BinaryEnum(b'a-value')), "
-            "(b'value-b', migrations.test_writer.BinaryEnum(b'value-b'))], "
-            "default=migrations.test_writer.BinaryEnum(b'value-b'))"
+            "(b'a-value', migrations.test_writer.BinaryEnum['A']), "
+            "(b'value-b', migrations.test_writer.BinaryEnum['B'])], "
+            "default=migrations.test_writer.BinaryEnum['B'])"
         )
         field = models.IntegerField(default=IntEnum.A, choices=[(m.value, m) for m in IntEnum])
         string = MigrationWriter.serialize(field)[0]
         self.assertEqual(
             string,
             "models.IntegerField(choices=["
-            "(1, migrations.test_writer.IntEnum(1)), "
-            "(2, migrations.test_writer.IntEnum(2))], "
-            "default=migrations.test_writer.IntEnum(1))"
+            "(1, migrations.test_writer.IntEnum['A']), "
+            "(2, migrations.test_writer.IntEnum['B'])], "
+            "default=migrations.test_writer.IntEnum['A'])"
         )
 
     def test_serialize_choices(self):
@@ -454,7 +474,7 @@ def test_serialize_class_based_validators(self):
         # Test a string regex with flag
         validator = RegexValidator(r'^[0-9]+$', flags=re.S)
         string = MigrationWriter.serialize(validator)[0]
-        self.assertEqual(string, "django.core.validators.RegexValidator('^[0-9]+$', flags=re.RegexFlag(16))")
+        self.assertEqual(string, "django.core.validators.RegexValidator('^[0-9]+$', flags=re.RegexFlag['DOTALL'])")
         self.serialize_round_trip(validator)
 
         # Test message and code

```


## Code snippets

### 1 - django/db/migrations/serializer.py:

Start line: 119, End line: 137

```python
class EnumSerializer(BaseSerializer):
    def serialize(self):
        enum_class = self.value.__class__
        module = enum_class.__module__
        v_string, v_imports = serializer_factory(self.value.value).serialize()
        imports = {'import %s' % module, *v_imports}
        return "%s.%s(%s)" % (module, enum_class.__name__, v_string), imports


class FloatSerializer(BaseSimpleSerializer):
    def serialize(self):
        if math.isnan(self.value) or math.isinf(self.value):
            return 'float("{}")'.format(self.value), set()
        return super().serialize()


class FrozensetSerializer(BaseSequenceSerializer):
    def _format(self):
        return "frozenset([%s])"
```
### 2 - django/db/migrations/exceptions.py:

Start line: 1, End line: 55

```python
from django.db.utils import DatabaseError


class AmbiguityError(Exception):
    """More than one migration matches a name prefix."""
    pass


class BadMigrationError(Exception):
    """There's a bad migration (unreadable/bad format/etc.)."""
    pass


class CircularDependencyError(Exception):
    """There's an impossible-to-resolve circular dependency."""
    pass


class InconsistentMigrationHistory(Exception):
    """An applied migration has some of its dependencies not applied."""
    pass


class InvalidBasesError(ValueError):
    """A model's base classes can't be resolved."""
    pass


class IrreversibleError(RuntimeError):
    """An irreversible migration is about to be reversed."""
    pass


class NodeNotFoundError(LookupError):
    """An attempt on a node is made that is not available in the graph."""

    def __init__(self, message, node, origin=None):
        self.message = message
        self.origin = origin
        self.node = node

    def __str__(self):
        return self.message

    def __repr__(self):
        return "NodeNotFoundError(%r)" % (self.node,)


class MigrationSchemaMissing(DatabaseError):
    pass


class InvalidMigrationPlan(ValueError):
    pass
```
### 3 - django/contrib/auth/migrations/0004_alter_user_username_opts.py:

Start line: 1, End line: 24

```python
from django.contrib.auth import validators
from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('auth', '0003_alter_user_email_max_length'),
    ]

    # No database changes; modifies validators and error_messages (#13147).
    operations = [
        migrations.AlterField(
            model_name='user',
            name='username',
            field=models.CharField(
                error_messages={'unique': 'A user with that username already exists.'}, max_length=30,
                validators=[validators.UnicodeUsernameValidator()],
                help_text='Required. 30 characters or fewer. Letters, digits and @/./+/-/_ only.',
                unique=True, verbose_name='username'
            ),
        ),
    ]
```
### 4 - django/contrib/auth/migrations/0007_alter_validators_add_error_messages.py:

Start line: 1, End line: 25

```python
from django.contrib.auth import validators
from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('auth', '0006_require_contenttypes_0002'),
    ]

    operations = [
        migrations.AlterField(
            model_name='user',
            name='username',
            field=models.CharField(
                error_messages={'unique': 'A user with that username already exists.'},
                help_text='Required. 30 characters or fewer. Letters, digits and @/./+/-/_ only.',
                max_length=30,
                unique=True,
                validators=[validators.UnicodeUsernameValidator()],
                verbose_name='username',
            ),
        ),
    ]
```
### 5 - django/db/migrations/state.py:

Start line: 580, End line: 599

```python
class ModelState:

    def get_field_by_name(self, name):
        for fname, field in self.fields:
            if fname == name:
                return field
        raise ValueError("No field called %s on model %s" % (name, self.name))

    def get_index_by_name(self, name):
        for index in self.options['indexes']:
            if index.name == name:
                return index
        raise ValueError("No index named %s on model %s" % (name, self.name))

    def get_constraint_by_name(self, name):
        for constraint in self.options['constraints']:
            if constraint.name == name:
                return constraint
        raise ValueError('No constraint named %s on model %s' % (name, self.name))

    def __repr__(self):
        return "<%s: '%s.%s'>" % (self.__class__.__name__, self.app_label, self.name)
```
### 6 - django/contrib/auth/migrations/0001_initial.py:

Start line: 1, End line: 105

```python
import django.contrib.auth.models
from django.contrib.auth import validators
from django.db import migrations, models
from django.utils import timezone


class Migration(migrations.Migration):

    dependencies = [
        ('contenttypes', '__first__'),
    ]

    operations = [
        migrations.CreateModel(
            name='Permission',
            fields=[
                ('id', models.AutoField(verbose_name='ID', serialize=False, auto_created=True, primary_key=True)),
                ('name', models.CharField(max_length=50, verbose_name='name')),
                ('content_type', models.ForeignKey(
                    to='contenttypes.ContentType',
                    on_delete=models.CASCADE,
                    to_field='id',
                    verbose_name='content type',
                )),
                ('codename', models.CharField(max_length=100, verbose_name='codename')),
            ],
            options={
                'ordering': ('content_type__app_label', 'content_type__model', 'codename'),
                'unique_together': {('content_type', 'codename')},
                'verbose_name': 'permission',
                'verbose_name_plural': 'permissions',
            },
            managers=[
                ('objects', django.contrib.auth.models.PermissionManager()),
            ],
        ),
        migrations.CreateModel(
            name='Group',
            fields=[
                ('id', models.AutoField(verbose_name='ID', serialize=False, auto_created=True, primary_key=True)),
                ('name', models.CharField(unique=True, max_length=80, verbose_name='name')),
                ('permissions', models.ManyToManyField(to='auth.Permission', verbose_name='permissions', blank=True)),
            ],
            options={
                'verbose_name': 'group',
                'verbose_name_plural': 'groups',
            },
            managers=[
                ('objects', django.contrib.auth.models.GroupManager()),
            ],
        ),
        migrations.CreateModel(
            name='User',
            fields=[
                ('id', models.AutoField(verbose_name='ID', serialize=False, auto_created=True, primary_key=True)),
                ('password', models.CharField(max_length=128, verbose_name='password')),
                ('last_login', models.DateTimeField(default=timezone.now, verbose_name='last login')),
                ('is_superuser', models.BooleanField(
                    default=False,
                    help_text='Designates that this user has all permissions without explicitly assigning them.',
                    verbose_name='superuser status'
                )),
                ('username', models.CharField(
                    help_text='Required. 30 characters or fewer. Letters, digits and @/./+/-/_ only.', unique=True,
                    max_length=30, verbose_name='username',
                    validators=[validators.UnicodeUsernameValidator()],
                )),
                ('first_name', models.CharField(max_length=30, verbose_name='first name', blank=True)),
                ('last_name', models.CharField(max_length=30, verbose_name='last name', blank=True)),
                ('email', models.EmailField(max_length=75, verbose_name='email address', blank=True)),
                ('is_staff', models.BooleanField(
                    default=False, help_text='Designates whether the user can log into this admin site.',
                    verbose_name='staff status'
                )),
                ('is_active', models.BooleanField(
                    default=True, verbose_name='active', help_text=(
                        'Designates whether this user should be treated as active. Unselect this instead of deleting '
                        'accounts.'
                    )
                )),
                ('date_joined', models.DateTimeField(default=timezone.now, verbose_name='date joined')),
                ('groups', models.ManyToManyField(
                    to='auth.Group', verbose_name='groups', blank=True, related_name='user_set',
                    related_query_name='user', help_text=(
                        'The groups this user belongs to. A user will get all permissions granted to each of their '
                        'groups.'
                    )
                )),
                ('user_permissions', models.ManyToManyField(
                    to='auth.Permission', verbose_name='user permissions', blank=True,
                    help_text='Specific permissions for this user.', related_name='user_set',
                    related_query_name='user')
                 ),
            ],
            options={
                'swappable': 'AUTH_USER_MODEL',
                'verbose_name': 'user',
                'verbose_name_plural': 'users',
            },
            managers=[
                ('objects', django.contrib.auth.models.UserManager()),
            ],
        ),
    ]
```
### 7 - django/db/migrations/questioner.py:

Start line: 162, End line: 185

```python
class InteractiveMigrationQuestioner(MigrationQuestioner):

    def ask_not_null_alteration(self, field_name, model_name):
        """Changing a NULL field to NOT NULL."""
        if not self.dry_run:
            choice = self._choice_input(
                "You are trying to change the nullable field '%s' on %s to non-nullable "
                "without a default; we can't do that (the database needs something to "
                "populate existing rows).\n"
                "Please select a fix:" % (field_name, model_name),
                [
                    ("Provide a one-off default now (will be set on all existing "
                     "rows with a null value for this column)"),
                    ("Ignore for now, and let me handle existing rows with NULL myself "
                     "(e.g. because you added a RunPython or RunSQL operation to handle "
                     "NULL values in a previous data migration)"),
                    "Quit, and let me add a default in models.py",
                ]
            )
            if choice == 2:
                return NOT_PROVIDED
            elif choice == 3:
                sys.exit(3)
            else:
                return self._ask_default()
        return None
```
### 8 - django/db/models/enums.py:

Start line: 36, End line: 76

```python
class ChoicesMeta(enum.EnumMeta):

    def __contains__(cls, member):
        if not isinstance(member, enum.Enum):
            # Allow non-enums to match against member values.
            return member in {x.value for x in cls}
        return super().__contains__(member)

    @property
    def names(cls):
        empty = ['__empty__'] if hasattr(cls, '__empty__') else []
        return empty + [member.name for member in cls]

    @property
    def choices(cls):
        empty = [(None, cls.__empty__)] if hasattr(cls, '__empty__') else []
        return empty + [(member.value, member.label) for member in cls]

    @property
    def labels(cls):
        return [label for _, label in cls.choices]

    @property
    def values(cls):
        return [value for value, _ in cls.choices]


class Choices(enum.Enum, metaclass=ChoicesMeta):
    """Class for creating enumerated choices."""
    pass


class IntegerChoices(int, Choices):
    """Class for creating enumerated integer choices."""
    pass


class TextChoices(str, Choices):
    """Class for creating enumerated string choices."""

    def _generate_next_value_(name, start, count, last_values):
        return name
```
### 9 - django/db/models/options.py:

Start line: 316, End line: 336

```python
class Options:

    def can_migrate(self, connection):
        """
        Return True if the model can/should be migrated on the `connection`.
        `connection` can be either a real connection or a connection alias.
        """
        if self.proxy or self.swapped or not self.managed:
            return False
        if isinstance(connection, str):
            connection = connections[connection]
        if self.required_db_vendor:
            return self.required_db_vendor == connection.vendor
        if self.required_db_features:
            return all(getattr(connection.features, feat, False)
                       for feat in self.required_db_features)
        return True

    @property
    def verbose_name_raw(self):
        """Return the untranslated verbose name."""
        with override(None):
            return str(self.verbose_name)
```
### 10 - django/db/migrations/questioner.py:

Start line: 227, End line: 240

```python
class NonInteractiveMigrationQuestioner(MigrationQuestioner):

    def ask_not_null_addition(self, field_name, model_name):
        # We can't ask the user, so act like the user aborted.
        sys.exit(3)

    def ask_not_null_alteration(self, field_name, model_name):
        # We can't ask the user, so set as not provided.
        return NOT_PROVIDED

    def ask_auto_now_add_addition(self, field_name, model_name):
        # We can't ask the user, so act like the user aborted.
        sys.exit(3)
```
### 59 - django/db/migrations/serializer.py:

Start line: 257, End line: 276

```python
class TypeSerializer(BaseSerializer):
    def serialize(self):
        special_cases = [
            (models.Model, "models.Model", []),
            (type(None), 'type(None)', []),
        ]
        for case, string, imports in special_cases:
            if case is self.value:
                return string, set(imports)
        if hasattr(self.value, "__module__"):
            module = self.value.__module__
            if module == builtins.__name__:
                return self.value.__name__, set()
            else:
                return "%s.%s" % (module, self.value.__name__), {"import %s" % module}


class UUIDSerializer(BaseSerializer):
    def serialize(self):
        return "uuid.%s" % repr(self.value), {"import uuid"}
```
### 71 - django/db/migrations/serializer.py:

Start line: 1, End line: 73

```python
import builtins
import collections.abc
import datetime
import decimal
import enum
import functools
import math
import re
import types
import uuid

from django.conf import SettingsReference
from django.db import models
from django.db.migrations.operations.base import Operation
from django.db.migrations.utils import COMPILED_REGEX_TYPE, RegexObject
from django.utils.functional import LazyObject, Promise
from django.utils.timezone import utc
from django.utils.version import get_docs_version


class BaseSerializer:
    def __init__(self, value):
        self.value = value

    def serialize(self):
        raise NotImplementedError('Subclasses of BaseSerializer must implement the serialize() method.')


class BaseSequenceSerializer(BaseSerializer):
    def _format(self):
        raise NotImplementedError('Subclasses of BaseSequenceSerializer must implement the _format() method.')

    def serialize(self):
        imports = set()
        strings = []
        for item in self.value:
            item_string, item_imports = serializer_factory(item).serialize()
            imports.update(item_imports)
            strings.append(item_string)
        value = self._format()
        return value % (", ".join(strings)), imports


class BaseSimpleSerializer(BaseSerializer):
    def serialize(self):
        return repr(self.value), set()


class ChoicesSerializer(BaseSerializer):
    def serialize(self):
        return serializer_factory(self.value.value).serialize()


class DateTimeSerializer(BaseSerializer):
    """For datetime.*, except datetime.datetime."""
    def serialize(self):
        return repr(self.value), {'import datetime'}


class DatetimeDatetimeSerializer(BaseSerializer):
    """For datetime.datetime."""
    def serialize(self):
        if self.value.tzinfo is not None and self.value.tzinfo != utc:
            self.value = self.value.astimezone(utc)
        imports = ["import datetime"]
        if self.value.tzinfo is not None:
            imports.append("from django.utils.timezone import utc")
        return repr(self.value).replace('<UTC>', 'utc'), set(imports)


class DecimalSerializer(BaseSerializer):
    def serialize(self):
        return repr(self.value), {"from decimal import Decimal"}
```
### 105 - django/db/migrations/serializer.py:

Start line: 106, End line: 116

```python
class DictionarySerializer(BaseSerializer):
    def serialize(self):
        imports = set()
        strings = []
        for k, v in sorted(self.value.items()):
            k_string, k_imports = serializer_factory(k).serialize()
            v_string, v_imports = serializer_factory(v).serialize()
            imports.update(k_imports)
            imports.update(v_imports)
            strings.append((k_string, v_string))
        return "{%s}" % (", ".join("%s: %s" % (k, v) for k, v in strings)), imports
```
### 115 - django/db/migrations/serializer.py:

Start line: 279, End line: 310

```python
class Serializer:
    _registry = {
        # Some of these are order-dependent.
        frozenset: FrozensetSerializer,
        list: SequenceSerializer,
        set: SetSerializer,
        tuple: TupleSerializer,
        dict: DictionarySerializer,
        models.Choices: ChoicesSerializer,
        enum.Enum: EnumSerializer,
        datetime.datetime: DatetimeDatetimeSerializer,
        (datetime.date, datetime.timedelta, datetime.time): DateTimeSerializer,
        SettingsReference: SettingsReferenceSerializer,
        float: FloatSerializer,
        (bool, int, type(None), bytes, str, range): BaseSimpleSerializer,
        decimal.Decimal: DecimalSerializer,
        (functools.partial, functools.partialmethod): FunctoolsPartialSerializer,
        (types.FunctionType, types.BuiltinFunctionType, types.MethodType): FunctionTypeSerializer,
        collections.abc.Iterable: IterableSerializer,
        (COMPILED_REGEX_TYPE, RegexObject): RegexSerializer,
        uuid.UUID: UUIDSerializer,
    }

    @classmethod
    def register(cls, type_, serializer):
        if not issubclass(serializer, BaseSerializer):
            raise ValueError("'%s' must inherit from 'BaseSerializer'." % serializer.__name__)
        cls._registry[type_] = serializer

    @classmethod
    def unregister(cls, type_):
        cls._registry.pop(type_)
```
