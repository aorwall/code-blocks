{
  "instance_id": "django__django-12519",
  "model_patch": "diff --git a/django/db/models/sql/query.py b/django/db/models/sql/query.py\nindex 78c4f47b5b..67019cd04e 100644\n--- a/django/db/models/sql/query.py\n+++ b/django/db/models/sql/query.py\n@@ -1930,20 +1930,23 @@ class Query(BaseExpression):\n         group_by = list(self.select)\n         if self.annotation_select:\n             for alias, annotation in self.annotation_select.items():\n-                signature = inspect.signature(annotation.get_group_by_cols)\n-                if 'alias' not in signature.parameters:\n-                    annotation_class = annotation.__class__\n-                    msg = (\n-                        '`alias=None` must be added to the signature of '\n-                        '%s.%s.get_group_by_cols().'\n-                    ) % (annotation_class.__module__, annotation_class.__qualname__)\n-                    warnings.warn(msg, category=RemovedInDjango40Warning)\n-                    group_by_cols = annotation.get_group_by_cols()\n+                if isinstance(annotation, Subquery):\n+                    group_by.append(annotation)\n                 else:\n-                    if not allow_aliases:\n-                        alias = None\n-                    group_by_cols = annotation.get_group_by_cols(alias=alias)\n-                group_by.extend(group_by_cols)\n+                    signature = inspect.signature(annotation.get_group_by_cols)\n+                    if 'alias' not in signature.parameters:\n+                        annotation_class = annotation.__class__\n+                        msg = (\n+                            '`alias=None` must be added to the signature of '\n+                            '%s.%s.get_group_by_cols().'\n+                        ) % (annotation_class.__module__, annotation_class.__qualname__)\n+                        warnings.warn(msg, category=RemovedInDjango40Warning)\n+                        group_by_cols = annotation.get_group_by_cols()\n+                    else:\n+                        if not allow_aliases:\n+                            alias = None\n+                        group_by_cols = annotation.get_group_by_cols(alias=alias)\n+                    group_by.extend(group_by_cols)\n         self.group_by = tuple(group_by)\n \n     def add_select_related(self, fields):\n",
  "model_name_or_path": "Devin",
  "pass_or_fail": "fail",
  "model_patch_files": [
    "django/db/models/sql/query.py"
  ],
  "repo": "django/django",
  "base_commit": "d4fff711d4c97356bd6ba1273d2a5e349326eb5f",
  "patch": "diff --git a/django/db/backends/mysql/base.py b/django/db/backends/mysql/base.py\n--- a/django/db/backends/mysql/base.py\n+++ b/django/db/backends/mysql/base.py\n@@ -364,3 +364,10 @@ def mysql_version(self):\n     @cached_property\n     def mysql_is_mariadb(self):\n         return 'mariadb' in self.mysql_server_info.lower()\n+\n+    @cached_property\n+    def sql_mode(self):\n+        with self.cursor() as cursor:\n+            cursor.execute('SELECT @@sql_mode')\n+            sql_mode = cursor.fetchone()\n+        return set(sql_mode[0].split(',') if sql_mode else ())\ndiff --git a/django/db/backends/mysql/validation.py b/django/db/backends/mysql/validation.py\n--- a/django/db/backends/mysql/validation.py\n+++ b/django/db/backends/mysql/validation.py\n@@ -10,11 +10,7 @@ def check(self, **kwargs):\n         return issues\n \n     def _check_sql_mode(self, **kwargs):\n-        with self.connection.cursor() as cursor:\n-            cursor.execute(\"SELECT @@sql_mode\")\n-            sql_mode = cursor.fetchone()\n-        modes = set(sql_mode[0].split(',') if sql_mode else ())\n-        if not (modes & {'STRICT_TRANS_TABLES', 'STRICT_ALL_TABLES'}):\n+        if not (self.connection.sql_mode & {'STRICT_TRANS_TABLES', 'STRICT_ALL_TABLES'}):\n             return [checks.Warning(\n                 \"MySQL Strict Mode is not set for database connection '%s'\" % self.connection.alias,\n                 hint=\"MySQL's Strict Mode fixes many data integrity problems in MySQL, \"\ndiff --git a/django/db/models/expressions.py b/django/db/models/expressions.py\n--- a/django/db/models/expressions.py\n+++ b/django/db/models/expressions.py\n@@ -6,6 +6,7 @@\n from django.core.exceptions import EmptyResultSet, FieldError\n from django.db import NotSupportedError, connection\n from django.db.models import fields\n+from django.db.models.constants import LOOKUP_SEP\n from django.db.models.query_utils import Q\n from django.utils.deconstruct import deconstructible\n from django.utils.functional import cached_property\n@@ -559,6 +560,14 @@ def as_sql(self, *args, **kwargs):\n             'only be used in a subquery.'\n         )\n \n+    def resolve_expression(self, *args, **kwargs):\n+        col = super().resolve_expression(*args, **kwargs)\n+        # FIXME: Rename possibly_multivalued to multivalued and fix detection\n+        # for non-multivalued JOINs (e.g. foreign key fields). This should take\n+        # into account\u00a0only many-to-many and one-to-many relationships.\n+        col.possibly_multivalued = LOOKUP_SEP in self.name\n+        return col\n+\n     def relabeled_clone(self, relabels):\n         return self\n \n@@ -747,6 +756,7 @@ def as_sql(self, compiler, connection):\n class Col(Expression):\n \n     contains_column_references = True\n+    possibly_multivalued = False\n \n     def __init__(self, alias, target, output_field=None):\n         if output_field is None:\n@@ -1042,7 +1052,10 @@ def as_sql(self, compiler, connection, template=None, **extra_context):\n     def get_group_by_cols(self, alias=None):\n         if alias:\n             return [Ref(alias, self)]\n-        return self.query.get_external_cols()\n+        external_cols = self.query.get_external_cols()\n+        if any(col.possibly_multivalued for col in external_cols):\n+            return [self]\n+        return external_cols\n \n \n class Exists(Subquery):\n",
  "test_patch": "diff --git a/tests/aggregation/tests.py b/tests/aggregation/tests.py\n--- a/tests/aggregation/tests.py\n+++ b/tests/aggregation/tests.py\n@@ -1,6 +1,7 @@\n import datetime\n import re\n from decimal import Decimal\n+from unittest import skipIf\n \n from django.core.exceptions import FieldError\n from django.db import connection\n@@ -1190,6 +1191,26 @@ def test_aggregation_subquery_annotation_values(self):\n             },\n         ])\n \n+    @skipUnlessDBFeature('supports_subqueries_in_group_by')\n+    @skipIf(\n+        connection.vendor == 'mysql' and 'ONLY_FULL_GROUP_BY' in connection.sql_mode,\n+        'GROUP BY optimization does not work properly when ONLY_FULL_GROUP_BY '\n+        'mode is enabled on MySQL, see #31331.',\n+    )\n+    def test_aggregation_subquery_annotation_multivalued(self):\n+        \"\"\"\n+        Subquery annotations must be included in the GROUP BY if they use\n+        potentially multivalued relations (contain the LOOKUP_SEP).\n+        \"\"\"\n+        subquery_qs = Author.objects.filter(\n+            pk=OuterRef('pk'),\n+            book__name=OuterRef('book__name'),\n+        ).values('pk')\n+        author_qs = Author.objects.annotate(\n+            subquery_id=Subquery(subquery_qs),\n+        ).annotate(count=Count('book'))\n+        self.assertEqual(author_qs.count(), Author.objects.count())\n+\n     def test_aggregation_order_by_not_selected_annotation_values(self):\n         result_asc = [\n             self.b4.pk,\n@@ -1248,6 +1269,7 @@ def test_group_by_exists_annotation(self):\n         ).annotate(total=Count('*'))\n         self.assertEqual(dict(has_long_books_breakdown), {True: 2, False: 3})\n \n+    @skipUnlessDBFeature('supports_subqueries_in_group_by')\n     def test_aggregation_subquery_annotation_related_field(self):\n         publisher = Publisher.objects.create(name=self.a9.name, num_awards=2)\n         book = Book.objects.create(\n@@ -1267,3 +1289,8 @@ def test_aggregation_subquery_annotation_related_field(self):\n             contact_publisher__isnull=False,\n         ).annotate(count=Count('authors'))\n         self.assertSequenceEqual(books_qs, [book])\n+        # FIXME: GROUP BY doesn't need to include a subquery with\n+        # non-multivalued JOINs, see Col.possibly_multivalued (refs #31150):\n+        # with self.assertNumQueries(1) as ctx:\n+        #     self.assertSequenceEqual(books_qs, [book])\n+        # self.assertEqual(ctx[0]['sql'].count('SELECT'), 2)\ndiff --git a/tests/check_framework/test_database.py b/tests/check_framework/test_database.py\n--- a/tests/check_framework/test_database.py\n+++ b/tests/check_framework/test_database.py\n@@ -2,7 +2,7 @@\n from unittest import mock\n \n from django.core.checks.database import check_database_backends\n-from django.db import connection\n+from django.db import connection, connections\n from django.test import TestCase\n \n \n@@ -18,6 +18,12 @@ def test_database_checks_called(self, mocked_check):\n \n     @unittest.skipUnless(connection.vendor == 'mysql', 'Test only for MySQL')\n     def test_mysql_strict_mode(self):\n+        def _clean_sql_mode():\n+            for alias in self.databases:\n+                if hasattr(connections[alias], 'sql_mode'):\n+                    del connections[alias].sql_mode\n+\n+        _clean_sql_mode()\n         good_sql_modes = [\n             'STRICT_TRANS_TABLES,STRICT_ALL_TABLES',\n             'STRICT_TRANS_TABLES',\n@@ -29,6 +35,7 @@ def test_mysql_strict_mode(self):\n                 return_value=(response,)\n             ):\n                 self.assertEqual(check_database_backends(databases=self.databases), [])\n+            _clean_sql_mode()\n \n         bad_sql_modes = ['', 'WHATEVER']\n         for response in bad_sql_modes:\n@@ -40,3 +47,4 @@ def test_mysql_strict_mode(self):\n                 result = check_database_backends(databases=self.databases)\n                 self.assertEqual(len(result), 2)\n                 self.assertEqual([r.id for r in result], ['mysql.W002', 'mysql.W002'])\n+            _clean_sql_mode()\n",
  "problem_statement": "Subquery annotations are omitted in group by query section if multiple annotation are declared\nDescription\n\t \n\t\t(last modified by Johannes Maron)\n\t \nSadly there is more regression in Django 3.0.2 even after #31094.\nBackground: It's the same query as #31094. I tried upgrading to Django 3.0.2 and now I get duplicate results. Even tho they query should be distinct. Where on 2.2 the queryset yields 490 results, it's 519 on 3.0.\nA quick diff on the queries still reveals a different grouped by section:\nThis is the new query on 3.0.2:\nSELECT DISTINCT \"camps_offer\".\"id\",\n\t\t\t\t\"camps_offer\".\"title\",\n\t\t\t\t\"camps_offer\".\"slug\",\n\t\t\t\t\"camps_offer\".\"is_active\",\n\t\t\t\t\"camps_offer\".\"modified\",\n\t\t\t\t\"camps_offer\".\"created\",\n\t\t\t\t\"camps_offer\".\"provider_id\",\n\t\t\t\t\"camps_offer\".\"activity_type\",\n\t\t\t\t\"camps_offer\".\"description\",\n\t\t\t\t\"camps_offer\".\"highlights\",\n\t\t\t\t\"camps_offer\".\"important_information\",\n\t\t\t\t\"camps_offer\".\"min_age\",\n\t\t\t\t\"camps_offer\".\"max_age\",\n\t\t\t\t\"camps_offer\".\"food\",\n\t\t\t\t\"camps_offer\".\"video\",\n\t\t\t\t\"camps_offer\".\"accommodation\",\n\t\t\t\t\"camps_offer\".\"accommodation_type\",\n\t\t\t\t\"camps_offer\".\"room_type\",\n\t\t\t\t\"camps_offer\".\"room_size_min\",\n\t\t\t\t\"camps_offer\".\"room_size_max\",\n\t\t\t\t\"camps_offer\".\"external_url\",\n\t\t\t\t\"camps_offer\".\"application_form\",\n\t\t\t\t\"camps_offer\".\"caseload\",\n\t\t\t\t\"camps_offer\".\"field_trips\",\n\t\t\t\tMIN(T4.\"retail_price\") AS \"min_retail_price\",\n\t\t\t\t(SELECT U0.\"id\"\n\t\t\t\t FROM \"camps_servicepackage\" U0\n\t\t\t\t\t\t INNER JOIN \"camps_region\" U2 ON (U0.\"region_id\" = U2.\"id\")\n\t\t\t\t WHERE (U0.\"company_id\" = 1 AND U0.\"option\" = \"camps_offer\".\"activity_type\" AND\n\t\t\t\t\t\tST_Contains(U2.\"locations\", T4.\"position\"))\n\t\t\t\t LIMIT 1)\t\t\t AS \"in_package\",\n\t\t\t\t\"camps_provider\".\"id\",\n\t\t\t\t\"camps_provider\".\"title\",\n\t\t\t\t\"camps_provider\".\"slug\",\n\t\t\t\t\"camps_provider\".\"is_active\",\n\t\t\t\t\"camps_provider\".\"modified\",\n\t\t\t\t\"camps_provider\".\"created\",\n\t\t\t\t\"camps_provider\".\"logo\",\n\t\t\t\t\"camps_provider\".\"description\",\n\t\t\t\t\"camps_provider\".\"video\",\n\t\t\t\t\"camps_provider\".\"external_url\",\n\t\t\t\t\"camps_provider\".\"terms\",\n\t\t\t\t\"camps_provider\".\"cancellation_policy\",\n\t\t\t\t\"camps_provider\".\"privacy_policy\",\n\t\t\t\t\"camps_provider\".\"application_form\"\nFROM \"camps_offer\"\n\t\t LEFT OUTER JOIN \"camps_bookingoption\" ON (\"camps_offer\".\"id\" = \"camps_bookingoption\".\"offer_id\")\n\t\t INNER JOIN \"camps_provider\" ON (\"camps_offer\".\"provider_id\" = \"camps_provider\".\"id\")\n\t\t INNER JOIN \"camps_bookingoption\" T4 ON (\"camps_offer\".\"id\" = T4.\"offer_id\")\nWHERE (\"camps_offer\".\"is_active\" = True AND \"camps_provider\".\"is_active\" = True AND\n\t T4.\"end\" >= STATEMENT_TIMESTAMP() AND T4.\"is_active\" = True AND \"camps_offer\".\"max_age\" >= 5 AND\n\t \"camps_offer\".\"min_age\" <= 13 AND (SELECT U0.\"id\"\n\t\t\t\t\t\t\t\t\t\t FROM \"camps_servicepackage\" U0\n\t\t\t\t\t\t\t\t\t\t\t\t INNER JOIN \"camps_region\" U2 ON (U0.\"region_id\" = U2.\"id\")\n\t\t\t\t\t\t\t\t\t\t WHERE (U0.\"company_id\" = 1 AND U0.\"option\" = \"camps_offer\".\"activity_type\" AND\n\t\t\t\t\t\t\t\t\t\t\t\t ST_Contains(U2.\"locations\", T4.\"position\"))\n\t\t\t\t\t\t\t\t\t\t LIMIT 1) IS NOT NULL)\nGROUP BY \"camps_offer\".\"id\", T4.\"position\", \"camps_provider\".\"id\"\nORDER BY \"camps_offer\".\"created\" ASC\nAnd what it was (and should be) on 2.2.9:\nSELECT DISTINCT \"camps_offer\".\"id\",\n\t\t\t\t\"camps_offer\".\"title\",\n\t\t\t\t\"camps_offer\".\"slug\",\n\t\t\t\t\"camps_offer\".\"is_active\",\n\t\t\t\t\"camps_offer\".\"modified\",\n\t\t\t\t\"camps_offer\".\"created\",\n\t\t\t\t\"camps_offer\".\"provider_id\",\n\t\t\t\t\"camps_offer\".\"activity_type\",\n\t\t\t\t\"camps_offer\".\"description\",\n\t\t\t\t\"camps_offer\".\"highlights\",\n\t\t\t\t\"camps_offer\".\"important_information\",\n\t\t\t\t\"camps_offer\".\"min_age\",\n\t\t\t\t\"camps_offer\".\"max_age\",\n\t\t\t\t\"camps_offer\".\"food\",\n\t\t\t\t\"camps_offer\".\"video\",\n\t\t\t\t\"camps_offer\".\"accommodation\",\n\t\t\t\t\"camps_offer\".\"accommodation_type\",\n\t\t\t\t\"camps_offer\".\"room_type\",\n\t\t\t\t\"camps_offer\".\"room_size_min\",\n\t\t\t\t\"camps_offer\".\"room_size_max\",\n\t\t\t\t\"camps_offer\".\"external_url\",\n\t\t\t\t\"camps_offer\".\"application_form\",\n\t\t\t\t\"camps_offer\".\"caseload\",\n\t\t\t\t\"camps_offer\".\"field_trips\",\n\t\t\t\tMIN(T4.\"retail_price\") AS \"min_retail_price\",\n\t\t\t\t(SELECT U0.\"id\"\n\t\t\t\t FROM \"camps_servicepackage\" U0\n\t\t\t\t\t\t INNER JOIN \"camps_region\" U2 ON (U0.\"region_id\" = U2.\"id\")\n\t\t\t\t WHERE (U0.\"company_id\" = 1 AND U0.\"option\" = (\"camps_offer\".\"activity_type\") AND\n\t\t\t\t\t\tST_Contains(U2.\"locations\", (T4.\"position\")))\n\t\t\t\t LIMIT 1)\t\t\t AS \"in_package\",\n\t\t\t\t\"camps_provider\".\"id\",\n\t\t\t\t\"camps_provider\".\"title\",\n\t\t\t\t\"camps_provider\".\"slug\",\n\t\t\t\t\"camps_provider\".\"is_active\",\n\t\t\t\t\"camps_provider\".\"modified\",\n\t\t\t\t\"camps_provider\".\"created\",\n\t\t\t\t\"camps_provider\".\"logo\",\n\t\t\t\t\"camps_provider\".\"description\",\n\t\t\t\t\"camps_provider\".\"video\",\n\t\t\t\t\"camps_provider\".\"external_url\",\n\t\t\t\t\"camps_provider\".\"terms\",\n\t\t\t\t\"camps_provider\".\"cancellation_policy\",\n\t\t\t\t\"camps_provider\".\"privacy_policy\",\n\t\t\t\t\"camps_provider\".\"application_form\"\nFROM \"camps_offer\"\n\t\t LEFT OUTER JOIN \"camps_bookingoption\" ON (\"camps_offer\".\"id\" = \"camps_bookingoption\".\"offer_id\")\n\t\t INNER JOIN \"camps_provider\" ON (\"camps_offer\".\"provider_id\" = \"camps_provider\".\"id\")\n\t\t INNER JOIN \"camps_bookingoption\" T4 ON (\"camps_offer\".\"id\" = T4.\"offer_id\")\nWHERE (\"camps_offer\".\"is_active\" = True AND \"camps_provider\".\"is_active\" = True AND\n\t T4.\"end\" >= (STATEMENT_TIMESTAMP()) AND T4.\"is_active\" = True AND (SELECT U0.\"id\"\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t FROM \"camps_servicepackage\" U0\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t INNER JOIN \"camps_region\" U2 ON (U0.\"region_id\" = U2.\"id\")\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t WHERE (U0.\"company_id\" = 1 AND\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t U0.\"option\" = (\"camps_offer\".\"activity_type\") AND\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t ST_Contains(U2.\"locations\", (T4.\"position\")))\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t LIMIT 1) IS NOT NULL)\nGROUP BY \"camps_offer\".\"id\",\n\t\t (SELECT U0.\"id\"\n\t\t FROM \"camps_servicepackage\" U0\n\t\t\t\t INNER JOIN \"camps_region\" U2 ON (U0.\"region_id\" = U2.\"id\")\n\t\t WHERE (U0.\"company_id\" = 1 AND U0.\"option\" = (\"camps_offer\".\"activity_type\") AND\n\t\t\t\t ST_Contains(U2.\"locations\", (T4.\"position\")))\n\t\t LIMIT 1), \"camps_provider\".\"id\"\nORDER BY \"camps_offer\".\"created\" ASC\n",
  "hints_text": "Johannes, I need to repeat my gentle request for a queryset (see comment:2 and comment:6 ) Can you provide a queryset? It's really hard to restore the original queryset from a raw SQL.\nI really try but without a queryset I was not able to reproduce this issue.\n@felixxm, it seems that Subquery annotation are omitted from the grouping section in 3.0. I will try to create a test case today. If you add the following test to 2.2.* anywhere in tests.aggregation it will pass, in 3.0 it will fail, because the subquery is missing from the grouping bit: def test_filtered_aggregate_ref_subquery_annotation_e_31150(self): from django.db.models import OuterRef, Subquery aggs = Author.objects.annotate( earliest_book_year=Subquery( Book.objects.filter( contact__pk=OuterRef('pk'), ).order_by('pubdate').values('pubdate__year')[:1] ), ).annotate(max_id=Max('id')) print(aggs.query) self.assertIn(str(aggs.query), \"\"\" SELECT \"aggregation_author\".\"id\", \"aggregation_author\".\"name\", \"aggregation_author\".\"age\", (SELECT django_date_extract('year', U0.\"pubdate\") FROM \"aggregation_book\" U0 WHERE U0.\"contact_id\" = (\"aggregation_author\".\"id\") ORDER BY U0.\"pubdate\" ASC LIMIT 1) AS \"earliest_book_year\", MAX(\"aggregation_author\".\"id\") AS \"max_id\" FROM \"aggregation_author\" GROUP BY \"aggregation_author\".\"id\", \"aggregation_author\".\"name\", \"aggregation_author\".\"age\", (SELECT django_date_extract('year', U0.\"pubdate\") FROM \"aggregation_book\" U0 WHERE U0.\"contact_id\" = (\"aggregation_author\".\"id\") ORDER BY U0.\"pubdate\" ASC LIMIT 1) \"\"\")\nOK, thank you for the test case Joe. I added the import line so it pops straight into ,aggregation.tests.AggregateTestCase and then, yes, there's a change of behaviour between 2.2 and 3.0.\nThe generated query effectively changed but the returned resultset should be the same since the subquery is a function of the outer query's primary key and the query is grouped by the outer query primary key. I don't think asserting against the generated query string is a proper test case; the generated SQL will change between Django versions but the returned result set should be the same.\nYes. I didn\u2019t take the test case as final. Just illustrating the issue. \ud83d\ude00 If it\u2019s equivalent then there\u2019s no issue, but I\u2019m assuming Joe is seeing what he thinks is a substantive regression?\nReplying to Simon Charette: The generated query effectively changed but the returned resultset should be the same since the subquery is a function of the outer query's primary key and the query is grouped by the outer query primary key. I came from a wrong result set and deduced the error from here on out. It took me a while to figure it out to, but sadly grouping by the outer reference is not the same as grouping by the query. Here an example: with t_w_douplicates as ( select abs(n) as pk, n as val from generate_series(-2, 2, 1) n ) select pk, ( select n from generate_series(2, 2) n where n = val ) from t_w_douplicates where ( select n from generate_series(2, 2) n where n = val ) is null GROUP BY pk, ( select n from generate_series(2, 2) n where n = val ); Which returns (0, null) (1, null) (2, null) And just using the outer ref: with t_w_douplicates as ( select abs(n) as pk, n as val from generate_series(-2, 2, 1) n ) select pk, ( select n from generate_series(2, 2) n where n = val ) from t_w_douplicates where ( select n from generate_series(2, 2) n where n = val ) is null GROUP BY pk, val; Which returns 4 results: (2, null) (1, null) (0, null) (1, null) I don't think asserting against the generated query string is a proper test case; the generated SQL will change between Django versions but the returned result set should be the same. Certainly, haha, that was just to illustrate how to get from the ORM to the SQL query in the description. The SQL sample now, shows how they produce different result sets.\nThanks for the extra details, I think I have a better picture of what's happening here. In the cases where an outer query spawns a multi-valued relationship and the subquery references one of these multi-valued relationship we must keep grouping by the subquery. In your original reports the INNER JOIN \"camps_bookingoption\" T4 joins spawns multiple rows for the same camps.Offer and then your subquery filter against (T4.\"position\"). In ORM terms that means we must keep returning self in Subquery.get_group_by_cols when any of our OuterRef include a __ which could point to a multi-valued relationship. We could go a bit further and only disable the optimization if any of the outer-ref in the __ chain is multi-valued by relying on getattr(rel, 'many_to_many', True) introspection but in all cases that means adding a way to taint Col instances with whether or not they are/could be multi-valued so get_group_by_cols can return self if any of get_external_cols is multi-valued I could see this tainting as being useful to warn about #10060 in the future since the logic could be based on this column or alias tainting. I'm happy to submit a patch or discuss any alternatives but it feels like the above solution solves the reported problem while maintaining the optimization for most of the cases.\nI give a quick shot at the above solution and came with this rough patch \u200bhttps://github.com/django/django/compare/master...charettes:ticket-31150 Johannes, could you give it a shot and report whether or not it addresses your problem? Do you confirm your original queryset was using an OuterRef with a reference to an outer-query multi-valued relationship?\nI tested Simon's patch applied to 3.0.3 and it now works as expected. So yes, I'd say go ahead!",
  "created_at": "2020-03-02T12:53:06Z",
  "version": "3.1",
  "FAIL_TO_PASS": "[\"test_aggregation_subquery_annotation_multivalued (aggregation.tests.AggregateTestCase)\"]",
  "PASS_TO_PASS": "[\"Subquery annotations are excluded from the GROUP BY if they are\", \"test_add_implementation (aggregation.tests.AggregateTestCase)\", \"test_aggregate_alias (aggregation.tests.AggregateTestCase)\", \"test_aggregate_annotation (aggregation.tests.AggregateTestCase)\", \"test_aggregate_in_order_by (aggregation.tests.AggregateTestCase)\", \"test_aggregate_multi_join (aggregation.tests.AggregateTestCase)\", \"test_aggregate_over_complex_annotation (aggregation.tests.AggregateTestCase)\", \"test_aggregation_exists_annotation (aggregation.tests.AggregateTestCase)\", \"test_aggregation_expressions (aggregation.tests.AggregateTestCase)\", \"test_aggregation_order_by_not_selected_annotation_values (aggregation.tests.AggregateTestCase)\", \"test_aggregation_subquery_annotation_exists (aggregation.tests.AggregateTestCase)\", \"test_aggregation_subquery_annotation_related_field (aggregation.tests.AggregateTestCase)\", \"test_aggregation_subquery_annotation_values (aggregation.tests.AggregateTestCase)\", \"test_annotate_basic (aggregation.tests.AggregateTestCase)\", \"test_annotate_defer (aggregation.tests.AggregateTestCase)\", \"test_annotate_defer_select_related (aggregation.tests.AggregateTestCase)\", \"test_annotate_m2m (aggregation.tests.AggregateTestCase)\", \"test_annotate_ordering (aggregation.tests.AggregateTestCase)\", \"test_annotate_over_annotate (aggregation.tests.AggregateTestCase)\", \"test_annotate_values (aggregation.tests.AggregateTestCase)\", \"test_annotate_values_aggregate (aggregation.tests.AggregateTestCase)\", \"test_annotate_values_list (aggregation.tests.AggregateTestCase)\", \"test_annotated_aggregate_over_annotated_aggregate (aggregation.tests.AggregateTestCase)\", \"test_annotation (aggregation.tests.AggregateTestCase)\", \"test_annotation_expressions (aggregation.tests.AggregateTestCase)\", \"test_arguments_must_be_expressions (aggregation.tests.AggregateTestCase)\", \"test_avg_decimal_field (aggregation.tests.AggregateTestCase)\", \"test_avg_duration_field (aggregation.tests.AggregateTestCase)\", \"test_backwards_m2m_annotate (aggregation.tests.AggregateTestCase)\", \"test_combine_different_types (aggregation.tests.AggregateTestCase)\", \"test_complex_aggregations_require_kwarg (aggregation.tests.AggregateTestCase)\", \"test_complex_values_aggregation (aggregation.tests.AggregateTestCase)\", \"test_count (aggregation.tests.AggregateTestCase)\", \"test_count_distinct_expression (aggregation.tests.AggregateTestCase)\", \"test_count_star (aggregation.tests.AggregateTestCase)\", \"test_database_checks_called (check_framework.test_database.DatabaseCheckTests)\", \"test_dates_with_aggregation (aggregation.tests.AggregateTestCase)\", \"test_decimal_max_digits_has_no_effect (aggregation.tests.AggregateTestCase)\", \"test_distinct_on_aggregate (aggregation.tests.AggregateTestCase)\", \"test_empty_aggregate (aggregation.tests.AggregateTestCase)\", \"test_even_more_aggregate (aggregation.tests.AggregateTestCase)\", \"test_expression_on_aggregation (aggregation.tests.AggregateTestCase)\", \"test_filter_aggregate (aggregation.tests.AggregateTestCase)\", \"test_filtering (aggregation.tests.AggregateTestCase)\", \"test_fkey_aggregate (aggregation.tests.AggregateTestCase)\", \"test_group_by_exists_annotation (aggregation.tests.AggregateTestCase)\", \"test_group_by_subquery_annotation (aggregation.tests.AggregateTestCase)\", \"test_grouped_annotation_in_group_by (aggregation.tests.AggregateTestCase)\", \"test_missing_output_field_raises_error (aggregation.tests.AggregateTestCase)\", \"test_more_aggregation (aggregation.tests.AggregateTestCase)\", \"test_multi_arg_aggregate (aggregation.tests.AggregateTestCase)\", \"test_multiple_aggregates (aggregation.tests.AggregateTestCase)\", \"test_non_grouped_annotation_not_in_group_by (aggregation.tests.AggregateTestCase)\", \"test_nonaggregate_aggregation_throws (aggregation.tests.AggregateTestCase)\", \"test_nonfield_annotation (aggregation.tests.AggregateTestCase)\", \"test_order_of_precedence (aggregation.tests.AggregateTestCase)\", \"test_related_aggregate (aggregation.tests.AggregateTestCase)\", \"test_reverse_fkey_annotate (aggregation.tests.AggregateTestCase)\", \"test_single_aggregate (aggregation.tests.AggregateTestCase)\", \"test_sum_distinct_aggregate (aggregation.tests.AggregateTestCase)\", \"test_sum_duration_field (aggregation.tests.AggregateTestCase)\", \"test_ticket11881 (aggregation.tests.AggregateTestCase)\", \"test_ticket12886 (aggregation.tests.AggregateTestCase)\", \"test_ticket17424 (aggregation.tests.AggregateTestCase)\", \"test_values_aggregation (aggregation.tests.AggregateTestCase)\", \"test_values_annotation_with_expression (aggregation.tests.AggregateTestCase)\"]",
  "environment_setup_commit": "0668164b4ac93a5be79f5b87fae83c657124d9ab",
  "patch_files": [
    "django/db/backends/mysql/base.py",
    "django/db/backends/mysql/validation.py",
    "django/db/models/expressions.py"
  ],
  "test_patch_files": [
    "tests/aggregation/tests.py",
    "tests/check_framework/test_database.py"
  ],
  "patch_diff_details": {
    "django/db/backends/mysql/base.py": {
      "diffs": [
        {
          "start_line_old": 367,
          "end_line_old": 367
        }
      ]
    },
    "django/db/backends/mysql/validation.py": {
      "diffs": [
        {
          "start_line_old": 13,
          "end_line_old": 17
        }
      ]
    },
    "django/db/models/expressions.py": {
      "diffs": [
        {
          "start_line_old": 9,
          "end_line_old": 9,
          "file_pos": 10,
          "file_context_length": 89000,
          "closest_snippet_id": "/tmp/repos/django/django/db/models/expressions.py_CombinedExpression.as_sql_CombinedExpression.resolve_expression.5.1",
          "closest_snippet_line_distance": 427
        },
        {
          "start_line_old": 562,
          "end_line_old": 562,
          "file_pos": 10,
          "file_context_length": 89000,
          "closest_snippet_id": "/tmp/repos/django/django/db/models/expressions.py_CombinedExpression.as_sql_CombinedExpression.resolve_expression.5.1",
          "closest_snippet_line_distance": 91
        },
        {
          "start_line_old": 750,
          "end_line_old": 750,
          "file_pos": 10,
          "file_context_length": 89000,
          "closest_snippet_id": "/tmp/repos/django/django/db/models/expressions.py_When_When.get_group_by_cols.cols.3.1",
          "closest_snippet_line_distance": 106,
          "pos": 62,
          "context_length": 33021
        },
        {
          "start_line_old": 1045,
          "end_line_old": 1045,
          "file_pos": 10,
          "file_context_length": 89000,
          "closest_snippet_id": "/tmp/repos/django/django/db/models/expressions.py_OrderBy.as_sql_OrderBy.as_sql.8.1",
          "closest_snippet_line_distance": 57,
          "pos": 109,
          "context_length": 55346
        }
      ]
    }
  },
  "vectors": 3424,
  "snippets": [
    {
      "position": 1,
      "id": "/tmp/repos/django/django/db/models/sql/query.py_Query.build_filter.19_Query.build_filter.31.1",
      "distance": 1.0988452434539795,
      "file_path": "django/db/models/sql/query.py",
      "start_line": 1281,
      "end_line": 1339,
      "tokens": 711,
      "context_length": 711
    },
    {
      "position": 2,
      "id": "/tmp/repos/django/django/db/models/sql/compiler.py_SQLCompiler.get_group_by_SQLCompiler.get_group_by.45.1",
      "distance": 1.123732089996338,
      "file_path": "django/db/models/sql/compiler.py",
      "start_line": 58,
      "end_line": 141,
      "tokens": 851,
      "context_length": 1562
    },
    {
      "position": 3,
      "id": "/tmp/repos/django/django/db/models/sql/query.py_Query.rewrite_cols_Query.rewrite_cols.orig_exprs.5.1",
      "distance": 1.1261262893676758,
      "file_path": "django/db/models/sql/query.py",
      "start_line": 363,
      "end_line": 413,
      "tokens": 494,
      "context_length": 2056
    },
    {
      "position": 4,
      "id": "/tmp/repos/django/django/db/models/sql/query.py_JoinPromoter.update_join_types_",
      "distance": 1.1431609392166138,
      "file_path": "django/db/models/sql/query.py",
      "start_line": 2317,
      "end_line": 2372,
      "tokens": 827,
      "context_length": 2883
    },
    {
      "position": 5,
      "id": "/tmp/repos/django/django/db/models/sql/query.py_Query.split_exclude_Query.split_exclude.23.1",
      "distance": 1.1469686031341553,
      "file_path": "django/db/models/sql/query.py",
      "start_line": 1695,
      "end_line": 1766,
      "tokens": 784,
      "context_length": 3667
    },
    {
      "position": 6,
      "id": "/tmp/repos/django/django/db/models/query.py_QuerySet._update.alters_data_QuerySet.values.4.1",
      "distance": 1.1623883247375488,
      "file_path": "django/db/models/query.py",
      "start_line": 790,
      "end_line": 829,
      "tokens": 322,
      "context_length": 3989
    },
    {
      "position": 7,
      "id": "/tmp/repos/django/django/db/models/sql/query.py_Query.set_group_by_Query.add_select_related.self.select_related.1",
      "distance": 1.1648229360580444,
      "file_path": "django/db/models/sql/query.py",
      "start_line": 1921,
      "end_line": 1963,
      "tokens": 356,
      "context_length": 4345
    },
    {
      "position": 8,
      "id": "/tmp/repos/django/django/db/models/query.py_QuerySet.__setstate___QuerySet.__len__.2.1",
      "distance": 1.1729358434677124,
      "file_path": "django/db/models/query.py",
      "start_line": 243,
      "end_line": 269,
      "tokens": 221,
      "context_length": 4566
    },
    {
      "position": 9,
      "id": "/tmp/repos/django/django/db/models/sql/compiler.py_SQLCompiler.get_select_SQLCompiler.get_select.14.1",
      "distance": 1.1743056774139404,
      "file_path": "django/db/models/sql/compiler.py",
      "start_line": 193,
      "end_line": 263,
      "tokens": 564,
      "context_length": 5130
    },
    {
      "position": 10,
      "id": "/tmp/repos/django/django/db/models/__init__.py_1_",
      "distance": 1.1779148578643799,
      "file_path": "django/db/models/__init__.py",
      "start_line": 1,
      "end_line": 52,
      "tokens": 605,
      "context_length": 5735
    },
    {
      "position": 11,
      "id": "/tmp/repos/django/django/db/models/sql/query.py_Query.deferred_to_data.8_Query.deferred_to_data.8.6.6.1",
      "distance": 1.1798220872879028,
      "file_path": "django/db/models/sql/query.py",
      "start_line": 696,
      "end_line": 731,
      "tokens": 389,
      "context_length": 6124
    },
    {
      "position": 12,
      "id": "/tmp/repos/django/django/db/models/sql/query.py_Query.resolve_ref_Query.resolve_ref.3.3.10.1",
      "distance": 1.1906230449676514,
      "file_path": "django/db/models/sql/query.py",
      "start_line": 1659,
      "end_line": 1693,
      "tokens": 399,
      "context_length": 6523
    },
    {
      "position": 13,
      "id": "/tmp/repos/django/django/db/models/sql/compiler.py_SQLCompiler.get_related_selections.13_SQLCompiler.get_related_selections.14.1",
      "distance": 1.1927900314331055,
      "file_path": "django/db/models/sql/compiler.py",
      "start_line": 864,
      "end_line": 956,
      "tokens": 829,
      "context_length": 7352
    },
    {
      "position": 14,
      "id": "/tmp/repos/django/django/db/models/query.py_prefetch_related_objects.13_prefetch_related_objects.13.7.2.16.8.new_obj_list.obj_list.1",
      "distance": 1.1929242610931396,
      "file_path": "django/db/models/query.py",
      "start_line": 1622,
      "end_line": 1728,
      "tokens": 1063,
      "context_length": 8415
    },
    {
      "position": 15,
      "id": "/tmp/repos/django/django/db/models/sql/compiler.py_SQLCompiler.get_order_by_SQLCompiler.get_order_by.seen.1",
      "distance": 1.199883222579956,
      "file_path": "django/db/models/sql/compiler.py",
      "start_line": 265,
      "end_line": 352,
      "tokens": 696,
      "context_length": 9111
    },
    {
      "position": 16,
      "id": "/tmp/repos/django/django/db/models/sql/query.py_Query_Query.output_field.1.2.1.1",
      "distance": 1.2066551446914673,
      "file_path": "django/db/models/sql/query.py",
      "start_line": 138,
      "end_line": 238,
      "tokens": 874,
      "context_length": 9985
    },
    {
      "position": 17,
      "id": "/tmp/repos/django/django/db/models/fields/related_lookups.py_RelatedIn.as_sql_RelatedIn.as_sql.1.5.2.1",
      "distance": 1.2129634618759155,
      "file_path": "django/db/models/fields/related_lookups.py",
      "start_line": 62,
      "end_line": 99,
      "tokens": 447,
      "context_length": 10432
    },
    {
      "position": 18,
      "id": "/tmp/repos/django/django/db/models/sql/query.py_Query.clear_limits_Query.add_distinct_fields.self.distinct.1",
      "distance": 1.2144618034362793,
      "file_path": "django/db/models/sql/query.py",
      "start_line": 1797,
      "end_line": 1846,
      "tokens": 330,
      "context_length": 10762
    },
    {
      "position": 19,
      "id": "/tmp/repos/django/django/db/models/sql/compiler.py_SQLCompiler.as_sql_SQLCompiler.as_sql.3.14.2",
      "distance": 1.215609073638916,
      "file_path": "django/db/models/sql/compiler.py",
      "start_line": 479,
      "end_line": 629,
      "tokens": 1392,
      "context_length": 12154
    },
    {
      "position": 20,
      "id": "/tmp/repos/django/django/db/models/sql/query.py_Query.setup_joins.16_Query.setup_joins.17.1",
      "distance": 1.2156157493591309,
      "file_path": "django/db/models/sql/query.py",
      "start_line": 1593,
      "end_line": 1617,
      "tokens": 227,
      "context_length": 12381
    },
    {
      "position": 21,
      "id": "/tmp/repos/django/django/db/models/query.py_QuerySet.__and___QuerySet.__or__.9.1",
      "distance": 1.2181086540222168,
      "file_path": "django/db/models/query.py",
      "start_line": 326,
      "end_line": 349,
      "tokens": 203,
      "context_length": 12584
    },
    {
      "position": 22,
      "id": "/tmp/repos/django/django/db/models/sql/query.py_Query.annotation_select_Query.extra_select.2.3.1.1",
      "distance": 1.222372055053711,
      "file_path": "django/db/models/sql/query.py",
      "start_line": 2129,
      "end_line": 2161,
      "tokens": 228,
      "context_length": 12812
    },
    {
      "position": 23,
      "id": "/tmp/repos/django/django/db/models/base.py_Model._check_ordering_Model._check_ordering.29.1",
      "distance": 1.2229441404342651,
      "file_path": "django/db/models/base.py",
      "start_line": 1665,
      "end_line": 1763,
      "tokens": 717,
      "context_length": 13529
    },
    {
      "position": 24,
      "id": "/tmp/repos/django/django/contrib/admin/views/main.py_ChangeList.get_query_string_ChangeList.get_results.self.paginator.1",
      "distance": 1.2232284545898438,
      "file_path": "django/contrib/admin/views/main.py",
      "start_line": 206,
      "end_line": 255,
      "tokens": 423,
      "context_length": 13952
    },
    {
      "position": 25,
      "id": "/tmp/repos/django/django/contrib/admin/views/main.py_ChangeList.get_filters_ChangeList.get_filters.13.3.1",
      "distance": 1.2246124744415283,
      "file_path": "django/contrib/admin/views/main.py",
      "start_line": 121,
      "end_line": 204,
      "tokens": 827,
      "context_length": 14779
    },
    {
      "position": 26,
      "id": "/tmp/repos/django/django/db/models/query.py_QuerySet._combinator_query_QuerySet.difference.2.2.1",
      "distance": 1.2247202396392822,
      "file_path": "django/db/models/query.py",
      "start_line": 968,
      "end_line": 999,
      "tokens": 341,
      "context_length": 15120
    },
    {
      "position": 27,
      "id": "/tmp/repos/django/django/conf/locale/nl/formats.py_DATETIME_INPUT_FORMATS_",
      "distance": 1.225167989730835,
      "file_path": "django/conf/locale/nl/formats.py",
      "start_line": 32,
      "end_line": 67,
      "tokens": 1371,
      "context_length": 16491
    },
    {
      "position": 28,
      "id": "/tmp/repos/django/django/db/backends/postgresql/operations.py_DatabaseOperations.prep_for_iexact_query_",
      "distance": 1.2311253547668457,
      "file_path": "django/db/backends/postgresql/operations.py",
      "start_line": 209,
      "end_line": 293,
      "tokens": 674,
      "context_length": 17165
    },
    {
      "position": 29,
      "id": "/tmp/repos/django/django/contrib/admin/views/main.py_ChangeList.get_queryset_ChangeList.get_queryset.2",
      "distance": 1.2313520908355713,
      "file_path": "django/contrib/admin/views/main.py",
      "start_line": 434,
      "end_line": 477,
      "tokens": 390,
      "context_length": 17555
    },
    {
      "position": 30,
      "id": "/tmp/repos/django/django/db/models/sql/query.py_Query.trim_joins_Query._gen_col_aliases.1",
      "distance": 1.232488989830017,
      "file_path": "django/db/models/sql/query.py",
      "start_line": 1619,
      "end_line": 1657,
      "tokens": 356,
      "context_length": 17911
    },
    {
      "position": 31,
      "id": "/tmp/repos/django/django/db/models/query.py_QuerySet._fetch_all_QuerySet._next_is_sticky.3.1",
      "distance": 1.23396635055542,
      "file_path": "django/db/models/query.py",
      "start_line": 1285,
      "end_line": 1303,
      "tokens": 186,
      "context_length": 18097
    },
    {
      "position": 32,
      "id": "/tmp/repos/django/django/db/models/sql/query.py_Query.names_to_path.3_Query.names_to_path.4.1",
      "distance": 1.2341150045394897,
      "file_path": "django/db/models/sql/query.py",
      "start_line": 1437,
      "end_line": 1515,
      "tokens": 734,
      "context_length": 18831
    },
    {
      "position": 33,
      "id": "/tmp/repos/django/django/db/models/expressions.py_When_When.get_group_by_cols.cols.3.1",
      "distance": 1.239029884338379,
      "file_path": "django/db/models/expressions.py",
      "start_line": 856,
      "end_line": 917,
      "tokens": 564,
      "context_length": 19395,
      "file_pos": 10
    },
    {
      "position": 34,
      "id": "/tmp/repos/django/django/db/models/query.py_QuerySet.order_by_QuerySet.reverse.5.1",
      "distance": 1.2419112920761108,
      "file_path": "django/db/models/query.py",
      "start_line": 1108,
      "end_line": 1143,
      "tokens": 314,
      "context_length": 19709
    },
    {
      "position": 35,
      "id": "/tmp/repos/django/django/db/models/sql/query.py_Query.trim_start_Query.trim_start.30.1",
      "distance": 1.2425487041473389,
      "file_path": "django/db/models/sql/query.py",
      "start_line": 2163,
      "end_line": 2235,
      "tokens": 774,
      "context_length": 20483
    },
    {
      "position": 36,
      "id": "/tmp/repos/django/django/db/models/fields/related.py_ManyToManyField._check_relationship_model_ManyToManyField._check_relationship_model.3.3.9.3.seen_from.5.1",
      "distance": 1.244767427444458,
      "file_path": "django/db/models/fields/related.py",
      "start_line": 1235,
      "end_line": 1352,
      "tokens": 963,
      "context_length": 21446
    },
    {
      "position": 37,
      "id": "/tmp/repos/django/django/contrib/admin/templatetags/admin_list.py_date_hierarchy_date_hierarchy.2.11.5.2.1",
      "distance": 1.2458999156951904,
      "file_path": "django/contrib/admin/templatetags/admin_list.py",
      "start_line": 356,
      "end_line": 428,
      "tokens": 631,
      "context_length": 22077
    },
    {
      "position": 38,
      "id": "/tmp/repos/django/django/db/models/sql/query.py_Query.demote_joins_Query.reset_refcounts.2.2",
      "distance": 1.2460654973983765,
      "file_path": "django/db/models/sql/query.py",
      "start_line": 800,
      "end_line": 826,
      "tokens": 280,
      "context_length": 22357
    },
    {
      "position": 39,
      "id": "/tmp/repos/django/django/contrib/admin/views/main.py_ChangeList_ChangeList.get_filters_params.8.1",
      "distance": 1.246934175491333,
      "file_path": "django/contrib/admin/views/main.py",
      "start_line": 48,
      "end_line": 119,
      "tokens": 636,
      "context_length": 22993
    },
    {
      "position": 40,
      "id": "/tmp/repos/django/django/contrib/admin/views/main.py_ChangeList.apply_select_related_",
      "distance": 1.2472258806228638,
      "file_path": "django/contrib/admin/views/main.py",
      "start_line": 479,
      "end_line": 510,
      "tokens": 224,
      "context_length": 23217
    },
    {
      "position": 41,
      "id": "/tmp/repos/django/django/db/models/sql/where.py_SubqueryConstraint_",
      "distance": 1.247879147529602,
      "file_path": "django/db/models/sql/where.py",
      "start_line": 230,
      "end_line": 246,
      "tokens": 130,
      "context_length": 23347
    },
    {
      "position": 42,
      "id": "/tmp/repos/django/django/db/backends/postgresql/features.py_operator_",
      "distance": 1.2479259967803955,
      "file_path": "django/db/backends/postgresql/features.py",
      "start_line": 1,
      "end_line": 81,
      "tokens": 674,
      "context_length": 24021
    },
    {
      "position": 43,
      "id": "/tmp/repos/django/django/db/models/sql/query.py_Query.promote_joins_Query.promote_joins.3.8.4",
      "distance": 1.2495512962341309,
      "file_path": "django/db/models/sql/query.py",
      "start_line": 766,
      "end_line": 798,
      "tokens": 392,
      "context_length": 24413
    },
    {
      "position": 44,
      "id": "/tmp/repos/django/django/db/backends/mysql/features.py_operator_DatabaseFeatures.supports_table_check_constraints.1",
      "distance": 1.2510318756103516,
      "file_path": "django/db/backends/mysql/features.py",
      "start_line": 1,
      "end_line": 101,
      "tokens": 834,
      "context_length": 25247
    },
    {
      "position": 45,
      "id": "/tmp/repos/django/django/db/backends/base/features.py_1_BaseDatabaseFeatures.can_introspect_default.1",
      "distance": 1.2527222633361816,
      "file_path": "django/db/backends/base/features.py",
      "start_line": 1,
      "end_line": 115,
      "tokens": 903,
      "context_length": 26150
    },
    {
      "position": 46,
      "id": "/tmp/repos/django/django/db/models/query.py_QuerySet.annotate_QuerySet.annotate.12.1",
      "distance": 1.2535816431045532,
      "file_path": "django/db/models/query.py",
      "start_line": 1061,
      "end_line": 1106,
      "tokens": 349,
      "context_length": 26499
    },
    {
      "position": 47,
      "id": "/tmp/repos/django/django/db/models/sql/query.py_Query.bump_prefix.3_Query.bump_prefix.12",
      "distance": 1.2568023204803467,
      "file_path": "django/db/models/sql/query.py",
      "start_line": 892,
      "end_line": 914,
      "tokens": 248,
      "context_length": 26747
    },
    {
      "position": 48,
      "id": "/tmp/repos/django/django/db/models/sql/where.py_WhereNode.as_sql_WhereNode.as_sql.9.1",
      "distance": 1.2589426040649414,
      "file_path": "django/db/models/sql/where.py",
      "start_line": 65,
      "end_line": 115,
      "tokens": 396,
      "context_length": 27143
    },
    {
      "position": 49,
      "id": "/tmp/repos/django/django/db/models/sql/query.py_Query.add_filter_Query.build_where.1.1",
      "distance": 1.2590556144714355,
      "file_path": "django/db/models/sql/query.py",
      "start_line": 1341,
      "end_line": 1362,
      "tokens": 250,
      "context_length": 27393
    },
    {
      "position": 50,
      "id": "/tmp/repos/django/django/db/models/sql/query.py_Query.add_filtered_relation_Query.add_filtered_relation.4",
      "distance": 1.2592121362686157,
      "file_path": "django/db/models/sql/query.py",
      "start_line": 1408,
      "end_line": 1419,
      "tokens": 137,
      "context_length": 27530
    },
    {
      "position": 51,
      "id": "/tmp/repos/django/django/contrib/postgres/fields/ranges.py_23_",
      "distance": 1.259270429611206,
      "file_path": "django/contrib/postgres/fields/ranges.py",
      "start_line": 231,
      "end_line": 321,
      "tokens": 489,
      "context_length": 28019
    },
    {
      "position": 52,
      "id": "/tmp/repos/django/django/db/models/query.py_Prefetch_Prefetch.__hash__.1.1",
      "distance": 1.2615315914154053,
      "file_path": "django/db/models/query.py",
      "start_line": 1534,
      "end_line": 1590,
      "tokens": 481,
      "context_length": 28500
    },
    {
      "position": 53,
      "id": "/tmp/repos/django/django/db/backends/postgresql/introspection.py_DatabaseIntrospection.data_types_reverse.get_constraints_DatabaseIntrospection.data_types_reverse.get_constraints.9",
      "distance": 1.2634639739990234,
      "file_path": "django/db/backends/postgresql/introspection.py",
      "start_line": 137,
      "end_line": 208,
      "tokens": 751,
      "context_length": 29251
    },
    {
      "position": 54,
      "id": "/tmp/repos/django/django/db/models/aggregates.py_Aggregate.resolve_expression_Aggregate.get_group_by_cols.1.1",
      "distance": 1.2648279666900635,
      "file_path": "django/db/models/aggregates.py",
      "start_line": 45,
      "end_line": 68,
      "tokens": 294,
      "context_length": 29545
    },
    {
      "position": 55,
      "id": "/tmp/repos/django/django/db/models/aggregates.py_Aggregate.as_sql_Aggregate._get_repr_options.4.1",
      "distance": 1.267317295074463,
      "file_path": "django/db/models/aggregates.py",
      "start_line": 70,
      "end_line": 96,
      "tokens": 266,
      "context_length": 29811
    },
    {
      "position": 56,
      "id": "/tmp/repos/django/django/db/models/sql/where.py_WhereNode.split_having_WhereNode.split_having.13.1",
      "distance": 1.2676713466644287,
      "file_path": "django/db/models/sql/where.py",
      "start_line": 32,
      "end_line": 63,
      "tokens": 317,
      "context_length": 30128
    },
    {
      "position": 57,
      "id": "/tmp/repos/django/django/db/models/fields/related_lookups.py_RelatedLookupMixin.as_sql_",
      "distance": 1.2679494619369507,
      "file_path": "django/db/models/fields/related_lookups.py",
      "start_line": 119,
      "end_line": 155,
      "tokens": 244,
      "context_length": 30372
    },
    {
      "position": 58,
      "id": "/tmp/repos/django/django/core/management/commands/inspectdb.py_Command.handle_inspection_Command.handle_inspection.5.15.14",
      "distance": 1.267995834350586,
      "file_path": "django/core/management/commands/inspectdb.py",
      "start_line": 38,
      "end_line": 173,
      "tokens": 1292,
      "context_length": 31664
    },
    {
      "position": 59,
      "id": "/tmp/repos/django/django/db/backends/postgresql/operations.py_DatabaseOperations.sequence_reset_sql_DatabaseOperations.sequence_reset_sql.5.1",
      "distance": 1.2689809799194336,
      "file_path": "django/db/backends/postgresql/operations.py",
      "start_line": 165,
      "end_line": 207,
      "tokens": 454,
      "context_length": 32118
    },
    {
      "position": 60,
      "id": "/tmp/repos/django/django/db/models/sql/compiler.py_SQLUpdateCompiler.pre_sql_setup_SQLUpdateCompiler.pre_sql_setup.19",
      "distance": 1.2714407444000244,
      "file_path": "django/db/models/sql/compiler.py",
      "start_line": 1513,
      "end_line": 1553,
      "tokens": 409,
      "context_length": 32527
    },
    {
      "position": 61,
      "id": "/tmp/repos/django/django/db/models/sql/subqueries.py_UpdateQuery_UpdateQuery.update_batch.2.3",
      "distance": 1.2721842527389526,
      "file_path": "django/db/models/sql/subqueries.py",
      "start_line": 47,
      "end_line": 75,
      "tokens": 210,
      "context_length": 32737
    },
    {
      "position": 62,
      "id": "/tmp/repos/django/django/db/models/expressions.py_Col_Col.get_db_converters.2.1",
      "distance": 1.2745752334594727,
      "file_path": "django/db/models/expressions.py",
      "start_line": 747,
      "end_line": 780,
      "tokens": 284,
      "context_length": 33021,
      "file_pos": 21
    },
    {
      "position": 63,
      "id": "/tmp/repos/django/django/db/models/sql/datastructures.py_Join.equals_Join.promote.3.1",
      "distance": 1.2748879194259644,
      "file_path": "django/db/models/sql/datastructures.py",
      "start_line": 117,
      "end_line": 137,
      "tokens": 144,
      "context_length": 33165
    },
    {
      "position": 64,
      "id": "/tmp/repos/django/django/db/models/sql/query.py_Query.has_select_fields_Query.get_meta.2.1",
      "distance": 1.2773189544677734,
      "file_path": "django/db/models/sql/query.py",
      "start_line": 240,
      "end_line": 286,
      "tokens": 335,
      "context_length": 33500
    },
    {
      "position": 65,
      "id": "/tmp/repos/django/django/db/migrations/autodetector.py_MigrationAutodetector.generate_created_models.6_MigrationAutodetector.generate_created_models.6.36.1.1",
      "distance": 1.2775477170944214,
      "file_path": "django/db/migrations/autodetector.py",
      "start_line": 525,
      "end_line": 671,
      "tokens": 1109,
      "context_length": 34609
    },
    {
      "position": 66,
      "id": "/tmp/repos/django/django/db/models/expressions.py_OrderBy.as_oracle_OrderBy.desc.self.descending.1",
      "distance": 1.2781684398651123,
      "file_path": "django/db/models/expressions.py",
      "start_line": 1125,
      "end_line": 1155,
      "tokens": 218,
      "context_length": 34827,
      "file_pos": 23
    },
    {
      "position": 67,
      "id": "/tmp/repos/django/django/db/models/expressions.py_Exists_Exists.select_format.3.2.1",
      "distance": 1.2788443565368652,
      "file_path": "django/db/models/expressions.py",
      "start_line": 1048,
      "end_line": 1075,
      "tokens": 261,
      "context_length": 35088,
      "file_pos": 23
    },
    {
      "position": 68,
      "id": "/tmp/repos/django/django/db/migrations/operations/models.py_CreateModel.reduce_CreateModel.reduce.2.1",
      "distance": 1.2789925336837769,
      "file_path": "django/db/migrations/operations/models.py",
      "start_line": 120,
      "end_line": 239,
      "tokens": 827,
      "context_length": 35915
    },
    {
      "position": 69,
      "id": "/tmp/repos/django/django/db/models/query.py_QuerySet._merge_known_related_objects_QuerySet._not_support_combined_queries.1.1",
      "distance": 1.2799917459487915,
      "file_path": "django/db/models/query.py",
      "start_line": 1316,
      "end_line": 1364,
      "tokens": 405,
      "context_length": 36320
    },
    {
      "position": 70,
      "id": "/tmp/repos/django/django/db/models/sql/query.py_Query.set_values_Query.set_values.9",
      "distance": 1.282629132270813,
      "file_path": "django/db/models/sql/query.py",
      "start_line": 2091,
      "end_line": 2127,
      "tokens": 292,
      "context_length": 36612
    },
    {
      "position": 71,
      "id": "/tmp/repos/django/django/db/models/sql/compiler.py_SQLCompiler.collapse_group_by_SQLCompiler.collapse_group_by.5.4.1",
      "distance": 1.283116340637207,
      "file_path": "django/db/models/sql/compiler.py",
      "start_line": 143,
      "end_line": 191,
      "tokens": 507,
      "context_length": 37119
    },
    {
      "position": 72,
      "id": "/tmp/repos/django/django/db/migrations/autodetector.py_MigrationAutodetector.generate_deleted_models_MigrationAutodetector.generate_deleted_models.6.25",
      "distance": 1.283172607421875,
      "file_path": "django/db/migrations/autodetector.py",
      "start_line": 707,
      "end_line": 794,
      "tokens": 789,
      "context_length": 37908
    },
    {
      "position": 73,
      "id": "/tmp/repos/django/django/db/backends/mysql/operations.py_DatabaseOperations.date_interval_sql_DatabaseOperations.random_function_sql.1.1",
      "distance": 1.2846527099609375,
      "file_path": "django/db/backends/mysql/operations.py",
      "start_line": 143,
      "end_line": 174,
      "tokens": 294,
      "context_length": 38202
    },
    {
      "position": 74,
      "id": "/tmp/repos/django/django/db/models/sql/query.py_1_JoinInfo.1",
      "distance": 1.2853859663009644,
      "file_path": "django/db/models/sql/query.py",
      "start_line": 1,
      "end_line": 67,
      "tokens": 471,
      "context_length": 38673
    },
    {
      "position": 75,
      "id": "/tmp/repos/django/django/db/backends/oracle/operations.py_DatabaseOperations_DatabaseOperations.integer_field_ranges.cache_key_culling_sql.1.1",
      "distance": 1.2858364582061768,
      "file_path": "django/db/backends/oracle/operations.py",
      "start_line": 21,
      "end_line": 73,
      "tokens": 574,
      "context_length": 39247
    },
    {
      "position": 76,
      "id": "/tmp/repos/django/django/db/backends/postgresql/operations.py_DatabaseOperations.date_trunc_sql_DatabaseOperations.fetch_returned_insert_rows.2.1",
      "distance": 1.286595344543457,
      "file_path": "django/db/backends/postgresql/operations.py",
      "start_line": 41,
      "end_line": 85,
      "tokens": 483,
      "context_length": 39730
    },
    {
      "position": 77,
      "id": "/tmp/repos/django/django/db/models/sql/where.py_WhereNode.relabeled_clone_WhereNode._resolve_leaf.2.1",
      "distance": 1.2870113849639893,
      "file_path": "django/db/models/sql/where.py",
      "start_line": 157,
      "end_line": 190,
      "tokens": 233,
      "context_length": 39963
    },
    {
      "position": 78,
      "id": "/tmp/repos/django/django/contrib/admin/templatetags/admin_list.py_result_headers_result_headers.3.23",
      "distance": 1.287125825881958,
      "file_path": "django/contrib/admin/templatetags/admin_list.py",
      "start_line": 105,
      "end_line": 194,
      "tokens": 788,
      "context_length": 40751
    },
    {
      "position": 79,
      "id": "/tmp/repos/django/django/db/backends/sqlite3/operations.py_DatabaseOperations.convert_uuidfield_value_",
      "distance": 1.287976622581482,
      "file_path": "django/db/backends/sqlite3/operations.py",
      "start_line": 296,
      "end_line": 339,
      "tokens": 431,
      "context_length": 41182
    },
    {
      "position": 80,
      "id": "/tmp/repos/django/django/db/models/deletion.py_operator_get_candidate_relations_to_delete.3.1",
      "distance": 1.2886675596237183,
      "file_path": "django/db/models/deletion.py",
      "start_line": 1,
      "end_line": 76,
      "tokens": 566,
      "context_length": 41748
    },
    {
      "position": 81,
      "id": "/tmp/repos/django/django/db/models/sql/compiler.py_SQLCompiler.as_subquery_condition_SQLCompiler.explain_query.4.1.2.1",
      "distance": 1.288782000541687,
      "file_path": "django/db/models/sql/compiler.py",
      "start_line": 1179,
      "end_line": 1200,
      "tokens": 213,
      "context_length": 41961
    },
    {
      "position": 82,
      "id": "/tmp/repos/django/django/db/models/expressions.py_OrderBy.as_sql_OrderBy.as_sql.8.1",
      "distance": 1.288848876953125,
      "file_path": "django/db/models/expressions.py",
      "start_line": 1102,
      "end_line": 1123,
      "tokens": 213,
      "context_length": 42174,
      "file_pos": 28
    },
    {
      "position": 83,
      "id": "/tmp/repos/django/django/contrib/admin/templatetags/admin_list.py_items_for_result_items_for_result.6.1",
      "distance": 1.2901968955993652,
      "file_path": "django/contrib/admin/templatetags/admin_list.py",
      "start_line": 214,
      "end_line": 298,
      "tokens": 809,
      "context_length": 42983
    },
    {
      "position": 84,
      "id": "/tmp/repos/django/django/contrib/admin/templatetags/admin_list.py_date_hierarchy_tag_",
      "distance": 1.2906484603881836,
      "file_path": "django/contrib/admin/templatetags/admin_list.py",
      "start_line": 431,
      "end_line": 489,
      "tokens": 343,
      "context_length": 43326
    },
    {
      "position": 85,
      "id": "/tmp/repos/django/django/db/models/sql/query.py_Query.get_external_cols_Query.resolve_lookup_value.2.1",
      "distance": 1.2910709381103516,
      "file_path": "django/db/models/sql/query.py",
      "start_line": 1049,
      "end_line": 1074,
      "tokens": 214,
      "context_length": 43540
    },
    {
      "position": 86,
      "id": "/tmp/repos/django/django/db/migrations/autodetector.py_MigrationAutodetector._build_migration_list.5_MigrationAutodetector._build_migration_list.5.7.num_ops.1",
      "distance": 1.291169285774231,
      "file_path": "django/db/migrations/autodetector.py",
      "start_line": 264,
      "end_line": 335,
      "tokens": 748,
      "context_length": 44288
    },
    {
      "position": 87,
      "id": "/tmp/repos/django/django/db/models/query.py_RawQuerySet.iterator_RawQuerySet.iterator.db.4.8.2.1",
      "distance": 1.2921234369277954,
      "file_path": "django/db/models/query.py",
      "start_line": 1450,
      "end_line": 1483,
      "tokens": 297,
      "context_length": 44585
    },
    {
      "position": 88,
      "id": "/tmp/repos/django/django/db/backends/mysql/operations.py_DatabaseOperations.explain_query_prefix_DatabaseOperations.explain_query_prefix.2.8.1",
      "distance": 1.2927608489990234,
      "file_path": "django/db/backends/mysql/operations.py",
      "start_line": 297,
      "end_line": 315,
      "tokens": 258,
      "context_length": 44843
    },
    {
      "position": 89,
      "id": "/tmp/repos/django/django/db/models/sql/subqueries.py_InsertQuery_",
      "distance": 1.294556736946106,
      "file_path": "django/db/models/sql/subqueries.py",
      "start_line": 137,
      "end_line": 163,
      "tokens": 173,
      "context_length": 45016
    },
    {
      "position": 90,
      "id": "/tmp/repos/django/django/core/management/commands/squashmigrations.py_Command.handle.29_Command.handle.40.6.4",
      "distance": 1.2948365211486816,
      "file_path": "django/core/management/commands/squashmigrations.py",
      "start_line": 136,
      "end_line": 200,
      "tokens": 652,
      "context_length": 45668
    },
    {
      "position": 91,
      "id": "/tmp/repos/django/django/db/models/sql/compiler.py_SQLCompiler.get_select_for_update_of_arguments_SQLCompiler.get_select_for_update_of_arguments._get_parent_klass_info.1.2",
      "distance": 1.2948739528656006,
      "file_path": "django/db/models/sql/compiler.py",
      "start_line": 958,
      "end_line": 979,
      "tokens": 179,
      "context_length": 45847
    },
    {
      "position": 92,
      "id": "/tmp/repos/django/django/contrib/postgres/search.py_SearchQuery_SearchQuery.__str__.2.1",
      "distance": 1.2949004173278809,
      "file_path": "django/contrib/postgres/search.py",
      "start_line": 158,
      "end_line": 204,
      "tokens": 432,
      "context_length": 46279
    },
    {
      "position": 93,
      "id": "/tmp/repos/django/django/db/models/deletion.py_Collector.collect.11_Collector.collect.15.3.3.3.1",
      "distance": 1.297863483428955,
      "file_path": "django/db/models/deletion.py",
      "start_line": 269,
      "end_line": 344,
      "tokens": 798,
      "context_length": 47077
    },
    {
      "position": 94,
      "id": "/tmp/repos/django/django/db/backends/sqlite3/operations.py_DatabaseOperations._quote_params_for_last_executed_query_DatabaseOperations._quote_params_for_last_executed_query.14.2.1",
      "distance": 1.298022985458374,
      "file_path": "django/db/backends/sqlite3/operations.py",
      "start_line": 121,
      "end_line": 146,
      "tokens": 279,
      "context_length": 47356
    },
    {
      "position": 95,
      "id": "/tmp/repos/django/django/db/models/sql/compiler.py_SQLCompiler.get_order_by.8_SQLCompiler.get_order_by.9.1",
      "distance": 1.2997474670410156,
      "file_path": "django/db/models/sql/compiler.py",
      "start_line": 354,
      "end_line": 387,
      "tokens": 388,
      "context_length": 47744
    },
    {
      "position": 96,
      "id": "/tmp/repos/django/django/db/models/sql/datastructures.py_Join.as_sql_Join.as_sql.17.1",
      "distance": 1.2999954223632812,
      "file_path": "django/db/models/sql/datastructures.py",
      "start_line": 59,
      "end_line": 102,
      "tokens": 419,
      "context_length": 48163
    },
    {
      "position": 97,
      "id": "/tmp/repos/django/django/db/models/sql/query.py_Query.combine.40_Query.combine.self.extra_order_by.1",
      "distance": 1.3009042739868164,
      "file_path": "django/db/models/sql/query.py",
      "start_line": 621,
      "end_line": 645,
      "tokens": 269,
      "context_length": 48432
    },
    {
      "position": 98,
      "id": "/tmp/repos/django/django/db/migrations/operations/base.py_1_Operation.references_field.2.1",
      "distance": 1.3009259700775146,
      "file_path": "django/db/migrations/operations/base.py",
      "start_line": 1,
      "end_line": 102,
      "tokens": 783,
      "context_length": 49215
    },
    {
      "position": 99,
      "id": "/tmp/repos/django/django/db/models/sql/compiler.py_SQLCompiler.get_select_for_update_of_arguments.result_SQLCompiler.get_select_for_update_of_arguments.9.1",
      "distance": 1.3022115230560303,
      "file_path": "django/db/models/sql/compiler.py",
      "start_line": 1015,
      "end_line": 1055,
      "tokens": 327,
      "context_length": 49542
    },
    {
      "position": 100,
      "id": "/tmp/repos/django/django/contrib/admin/views/main.py_ChangeList._get_deterministic_ordering_ChangeList._get_deterministic_ordering.6.1",
      "distance": 1.3024945259094238,
      "file_path": "django/contrib/admin/views/main.py",
      "start_line": 332,
      "end_line": 392,
      "tokens": 508,
      "context_length": 50050
    },
    {
      "position": 101,
      "id": "/tmp/repos/django/django/db/models/sql/query.py_Query.get_aggregation_Query.get_aggregation.25.1",
      "distance": 1.302704095840454,
      "file_path": "django/db/models/sql/query.py",
      "start_line": 415,
      "end_line": 508,
      "tokens": 917,
      "context_length": 50967
    },
    {
      "position": 102,
      "id": "/tmp/repos/django/django/db/backends/base/operations.py_BaseDatabaseOperations.date_interval_sql_BaseDatabaseOperations.fetch_returned_insert_columns.2.1",
      "distance": 1.3030171394348145,
      "file_path": "django/db/backends/base/operations.py",
      "start_line": 102,
      "end_line": 185,
      "tokens": 718,
      "context_length": 51685
    },
    {
      "position": 103,
      "id": "/tmp/repos/django/django/db/models/sql/query.py_Query.deferred_to_data_Query.deferred_to_data.7.10.1",
      "distance": 1.3031085729599,
      "file_path": "django/db/models/sql/query.py",
      "start_line": 647,
      "end_line": 694,
      "tokens": 511,
      "context_length": 52196
    },
    {
      "position": 104,
      "id": "/tmp/repos/django/django/db/models/query.py_RawQuerySet.prefetch_related_RawQuerySet.__iter__.2.1",
      "distance": 1.3034155368804932,
      "file_path": "django/db/models/query.py",
      "start_line": 1410,
      "end_line": 1448,
      "tokens": 308,
      "context_length": 52504
    },
    {
      "position": 105,
      "id": "/tmp/repos/django/django/db/models/sql/query.py_Query.combine_Query.combine.39",
      "distance": 1.3034887313842773,
      "file_path": "django/db/models/sql/query.py",
      "start_line": 546,
      "end_line": 620,
      "tokens": 809,
      "context_length": 53313
    },
    {
      "position": 106,
      "id": "/tmp/repos/django/django/core/management/commands/squashmigrations.py_Command.handle_Command.handle.28.first_migration.1",
      "distance": 1.3041709661483765,
      "file_path": "django/core/management/commands/squashmigrations.py",
      "start_line": 45,
      "end_line": 134,
      "tokens": 791,
      "context_length": 54104
    },
    {
      "position": 107,
      "id": "/tmp/repos/django/django/views/i18n.py_js_catalog_template_js_catalog_template.1",
      "distance": 1.3041741847991943,
      "file_path": "django/views/i18n.py",
      "start_line": 88,
      "end_line": 191,
      "tokens": 711,
      "context_length": 54815
    },
    {
      "position": 108,
      "id": "/tmp/repos/django/django/db/backends/base/operations.py_BaseDatabaseOperations.explain_query_prefix_",
      "distance": 1.3056361675262451,
      "file_path": "django/db/backends/base/operations.py",
      "start_line": 672,
      "end_line": 692,
      "tokens": 187,
      "context_length": 55002
    },
    {
      "position": 109,
      "id": "/tmp/repos/django/django/db/models/expressions.py_Subquery_Subquery.get_group_by_cols.2.1",
      "distance": 1.3063864707946777,
      "file_path": "django/db/models/expressions.py",
      "start_line": 996,
      "end_line": 1045,
      "tokens": 344,
      "context_length": 55346,
      "file_pos": 33
    },
    {
      "position": 110,
      "id": "/tmp/repos/django/django/db/models/sql/query.py_Query.get_count_Query.explain.6.1",
      "distance": 1.3069372177124023,
      "file_path": "django/db/models/sql/query.py",
      "start_line": 510,
      "end_line": 544,
      "tokens": 282,
      "context_length": 55628
    },
    {
      "position": 111,
      "id": "/tmp/repos/django/django/contrib/postgres/fields/ranges.py_RangeContainedBy_RangeContainedBy.get_prep_lookup.1.1",
      "distance": 1.307701826095581,
      "file_path": "django/contrib/postgres/fields/ranges.py",
      "start_line": 199,
      "end_line": 228,
      "tokens": 281,
      "context_length": 55909
    },
    {
      "position": 112,
      "id": "/tmp/repos/django/django/db/models/query.py_QuerySet.only_QuerySet.only.8.1",
      "distance": 1.307884693145752,
      "file_path": "django/db/models/query.py",
      "start_line": 1162,
      "end_line": 1181,
      "tokens": 209,
      "context_length": 56118
    },
    {
      "position": 113,
      "id": "/tmp/repos/django/django/db/migrations/autodetector.py_MigrationAutodetector.generate_altered_options_MigrationAutodetector.generate_altered_options.3.6.1",
      "distance": 1.3082208633422852,
      "file_path": "django/db/migrations/autodetector.py",
      "start_line": 1146,
      "end_line": 1180,
      "tokens": 296,
      "context_length": 56414
    },
    {
      "position": 114,
      "id": "/tmp/repos/django/django/contrib/gis/db/models/lookups.py_9_CoveredByLookup.lookup_name.1",
      "distance": 1.3090777397155762,
      "file_path": "django/contrib/gis/db/models/lookups.py",
      "start_line": 86,
      "end_line": 217,
      "tokens": 762,
      "context_length": 57176
    },
    {
      "position": 115,
      "id": "/tmp/repos/django/django/contrib/postgres/constraints.py_1_ExclusionConstraint._get_condition_sql.4.1",
      "distance": 1.3092424869537354,
      "file_path": "django/contrib/postgres/constraints.py",
      "start_line": 1,
      "end_line": 51,
      "tokens": 427,
      "context_length": 57603
    },
    {
      "position": 116,
      "id": "/tmp/repos/django/django/db/models/sql/compiler.py_SQLCompiler.get_combinator_sql_SQLCompiler.get_combinator_sql.14.1",
      "distance": 1.310443639755249,
      "file_path": "django/db/models/sql/compiler.py",
      "start_line": 424,
      "end_line": 477,
      "tokens": 548,
      "context_length": 58151
    },
    {
      "position": 117,
      "id": "/tmp/repos/django/django/db/models/query.py_prefetch_one_level.29_prefetch_one_level.30.1",
      "distance": 1.310556173324585,
      "file_path": "django/db/models/query.py",
      "start_line": 1843,
      "end_line": 1875,
      "tokens": 314,
      "context_length": 58465
    },
    {
      "position": 118,
      "id": "/tmp/repos/django/django/db/models/sql/subqueries.py_1_DeleteQuery.delete_batch.6.1",
      "distance": 1.3109116554260254,
      "file_path": "django/db/models/sql/subqueries.py",
      "start_line": 1,
      "end_line": 44,
      "tokens": 320,
      "context_length": 58785
    },
    {
      "position": 119,
      "id": "/tmp/repos/django/django/db/models/manager.py_copy_BaseManager.creation_counter.__hash__.1.1",
      "distance": 1.311448335647583,
      "file_path": "django/db/models/manager.py",
      "start_line": 1,
      "end_line": 162,
      "tokens": 1223,
      "context_length": 60008
    },
    {
      "position": 120,
      "id": "/tmp/repos/django/django/db/models/sql/query.py_Query.add_ordering_Query.clear_ordering.4.self.default_ordering.1",
      "distance": 1.312020182609558,
      "file_path": "django/db/models/sql/query.py",
      "start_line": 1886,
      "end_line": 1919,
      "tokens": 279,
      "context_length": 60287
    },
    {
      "position": 121,
      "id": "/tmp/repos/django/django/db/migrations/optimizer.py_MigrationOptimizer.optimize_inner_",
      "distance": 1.3123161792755127,
      "file_path": "django/db/migrations/optimizer.py",
      "start_line": 41,
      "end_line": 71,
      "tokens": 249,
      "context_length": 60536
    },
    {
      "position": 122,
      "id": "/tmp/repos/django/django/contrib/postgres/aggregates/statistics.py_1_",
      "distance": 1.314119577407837,
      "file_path": "django/contrib/postgres/aggregates/statistics.py",
      "start_line": 1,
      "end_line": 66,
      "tokens": 419,
      "context_length": 60955
    },
    {
      "position": 123,
      "id": "/tmp/repos/django/django/conf/locale/sr_Latn/formats.py_DATE_FORMAT_",
      "distance": 1.3148016929626465,
      "file_path": "django/conf/locale/sr_Latn/formats.py",
      "start_line": 5,
      "end_line": 40,
      "tokens": 726,
      "context_length": 61681
    },
    {
      "position": 124,
      "id": "/tmp/repos/django/django/db/backends/mysql/operations.py_uuid_DatabaseOperations.explain_prefix.1",
      "distance": 1.3160715103149414,
      "file_path": "django/db/backends/mysql/operations.py",
      "start_line": 1,
      "end_line": 35,
      "tokens": 282,
      "context_length": 61963
    },
    {
      "position": 125,
      "id": "/tmp/repos/django/django/db/models/query.py_QuerySet_QuerySet.__getstate__.2",
      "distance": 1.3161697387695312,
      "file_path": "django/db/models/query.py",
      "start_line": 184,
      "end_line": 241,
      "tokens": 453,
      "context_length": 62416
    },
    {
      "position": 126,
      "id": "/tmp/repos/django/django/contrib/admin/views/main.py_ChangeList.get_ordering_ChangeList.get_ordering.7.1",
      "distance": 1.3165252208709717,
      "file_path": "django/contrib/admin/views/main.py",
      "start_line": 289,
      "end_line": 330,
      "tokens": 388,
      "context_length": 62804
    },
    {
      "position": 127,
      "id": "/tmp/repos/django/django/db/models/query.py_get_prefetcher_get_prefetcher.9.1",
      "distance": 1.316551685333252,
      "file_path": "django/db/models/query.py",
      "start_line": 1731,
      "end_line": 1775,
      "tokens": 439,
      "context_length": 63243
    },
    {
      "position": 128,
      "id": "/tmp/repos/django/django/db/models/sql/compiler.py_SQLCompiler.get_from_clause_SQLCompiler.get_from_clause.6.1",
      "distance": 1.3167012929916382,
      "file_path": "django/db/models/sql/compiler.py",
      "start_line": 748,
      "end_line": 780,
      "tokens": 332,
      "context_length": 63575
    },
    {
      "position": 129,
      "id": "/tmp/repos/django/django/contrib/admin/options.py_ModelAdmin.changelist_view.24_ModelAdmin.changelist_view.32.1",
      "distance": 1.3168696165084839,
      "file_path": "django/contrib/admin/options.py",
      "start_line": 1740,
      "end_line": 1821,
      "tokens": 744,
      "context_length": 64319
    },
    {
      "position": 130,
      "id": "/tmp/repos/django/django/db/migrations/operations/models.py_1_ModelOperation.reduce.1.1",
      "distance": 1.31741464138031,
      "file_path": "django/db/migrations/operations/models.py",
      "start_line": 1,
      "end_line": 38,
      "tokens": 238,
      "context_length": 64557
    },
    {
      "position": 131,
      "id": "/tmp/repos/django/django/db/models/query.py_1_BaseIterable.__init__.self.chunk_size.1",
      "distance": 1.3178133964538574,
      "file_path": "django/db/models/query.py",
      "start_line": 1,
      "end_line": 41,
      "tokens": 304,
      "context_length": 64861
    },
    {
      "position": 132,
      "id": "/tmp/repos/django/django/db/migrations/operations/models.py_AlterOrderWithRespectTo.database_backwards_AlterOrderWithRespectTo.describe.1.1",
      "distance": 1.3179194927215576,
      "file_path": "django/db/migrations/operations/models.py",
      "start_line": 609,
      "end_line": 622,
      "tokens": 137,
      "context_length": 64998
    },
    {
      "position": 133,
      "id": "/tmp/repos/django/django/db/models/sql/compiler.py_collections_15",
      "distance": 1.318000316619873,
      "file_path": "django/db/models/sql/compiler.py",
      "start_line": 1,
      "end_line": 18,
      "tokens": 157,
      "context_length": 65155
    },
    {
      "position": 134,
      "id": "/tmp/repos/django/django/db/models/base.py_35_",
      "distance": 1.3187353610992432,
      "file_path": "django/db/models/base.py",
      "start_line": 1865,
      "end_line": 1916,
      "tokens": 351,
      "context_length": 65506
    },
    {
      "position": 135,
      "id": "/tmp/repos/django/django/contrib/postgres/aggregates/mixins.py_OrderableAggMixin.as_sql_OrderableAggMixin.as_sql.2.1",
      "distance": 1.3195035457611084,
      "file_path": "django/contrib/postgres/aggregates/mixins.py",
      "start_line": 22,
      "end_line": 34,
      "tokens": 128,
      "context_length": 65634
    },
    {
      "position": 136,
      "id": "/tmp/repos/django/django/db/models/aggregates.py_Max_",
      "distance": 1.320476770401001,
      "file_path": "django/db/models/aggregates.py",
      "start_line": 122,
      "end_line": 158,
      "tokens": 245,
      "context_length": 65879
    },
    {
      "position": 137,
      "id": "/tmp/repos/django/django/db/models/expressions.py_Case_Case.copy.3.1",
      "distance": 1.321041226387024,
      "file_path": "django/db/models/expressions.py",
      "start_line": 920,
      "end_line": 966,
      "tokens": 377,
      "context_length": 66256,
      "file_pos": 41
    },
    {
      "position": 138,
      "id": "/tmp/repos/django/django/conf/locale/sr/formats.py_DATE_FORMAT_",
      "distance": 1.3212430477142334,
      "file_path": "django/conf/locale/sr/formats.py",
      "start_line": 5,
      "end_line": 40,
      "tokens": 726,
      "context_length": 66982
    },
    {
      "position": 139,
      "id": "/tmp/repos/django/django/db/models/expressions.py_CombinedExpression.as_sql_CombinedExpression.resolve_expression.5.1",
      "distance": 1.3213783502578735,
      "file_path": "django/db/models/expressions.py",
      "start_line": 436,
      "end_line": 471,
      "tokens": 385,
      "context_length": 67367,
      "file_pos": 42
    },
    {
      "position": 140,
      "id": "/tmp/repos/django/django/contrib/postgres/aggregates/mixins.py_OrderableAggMixin.set_source_expressions_",
      "distance": 1.321521282196045,
      "file_path": "django/contrib/postgres/aggregates/mixins.py",
      "start_line": 36,
      "end_line": 49,
      "tokens": 145,
      "context_length": 67512
    },
    {
      "position": 141,
      "id": "/tmp/repos/django/django/db/backends/oracle/operations.py_DatabaseOperations.integer_field_ranges.subtract_temporals_",
      "distance": 1.3222055435180664,
      "file_path": "django/db/backends/oracle/operations.py",
      "start_line": 618,
      "end_line": 644,
      "tokens": 303,
      "context_length": 67815
    },
    {
      "position": 142,
      "id": "/tmp/repos/django/django/db/models/sql/compiler.py_SQLCompiler.get_extra_select_SQLCompiler.get_extra_select.3.1",
      "distance": 1.3236078023910522,
      "file_path": "django/db/models/sql/compiler.py",
      "start_line": 389,
      "end_line": 397,
      "tokens": 119,
      "context_length": 67934
    },
    {
      "position": 143,
      "id": "/tmp/repos/django/django/db/models/sql/compiler.py_SQLCompiler.get_distinct_SQLCompiler.get_distinct.6.1",
      "distance": 1.324356198310852,
      "file_path": "django/db/models/sql/compiler.py",
      "start_line": 675,
      "end_line": 697,
      "tokens": 186,
      "context_length": 68120
    },
    {
      "position": 144,
      "id": "/tmp/repos/django/django/contrib/gis/db/models/__init__.py_1_",
      "distance": 1.3248519897460938,
      "file_path": "django/contrib/gis/db/models/__init__.py",
      "start_line": 1,
      "end_line": 19,
      "tokens": 204,
      "context_length": 68324
    },
    {
      "position": 145,
      "id": "/tmp/repos/django/django/db/models/fields/related_lookups.py_1_MultiColSource.get_lookup.1.1",
      "distance": 1.3249015808105469,
      "file_path": "django/db/models/fields/related_lookups.py",
      "start_line": 1,
      "end_line": 23,
      "tokens": 170,
      "context_length": 68494
    },
    {
      "position": 146,
      "id": "/tmp/repos/django/django/db/models/options.py_bisect_DEFAULT_NAMES.1",
      "distance": 1.3253376483917236,
      "file_path": "django/db/models/options.py",
      "start_line": 1,
      "end_line": 34,
      "tokens": 285,
      "context_length": 68779
    }
  ],
  "files": [
    {
      "file_path": "django/db/models/sql/query.py",
      "position": 1,
      "tokens": 21669,
      "context_length": 21669
    },
    {
      "file_path": "django/db/models/sql/compiler.py",
      "position": 2,
      "tokens": 14056,
      "context_length": 35725
    },
    {
      "file_path": "django/db/models/query.py",
      "position": 3,
      "tokens": 17019,
      "context_length": 52744
    },
    {
      "file_path": "django/db/models/__init__.py",
      "position": 4,
      "tokens": 605,
      "context_length": 53349
    },
    {
      "file_path": "django/db/models/fields/related_lookups.py",
      "position": 5,
      "tokens": 1449,
      "context_length": 54798
    },
    {
      "file_path": "django/db/models/base.py",
      "position": 6,
      "tokens": 15350,
      "context_length": 70148
    },
    {
      "file_path": "django/contrib/admin/views/main.py",
      "position": 7,
      "tokens": 4298,
      "context_length": 74446
    },
    {
      "file_path": "django/conf/locale/nl/formats.py",
      "position": 8,
      "tokens": 1883,
      "context_length": 76329
    },
    {
      "file_path": "django/db/backends/postgresql/operations.py",
      "position": 9,
      "tokens": 2669,
      "context_length": 78998
    },
    {
      "file_path": "django/db/models/expressions.py",
      "position": 10,
      "tokens": 10002,
      "context_length": 89000
    },
    {
      "file_path": "django/db/models/fields/related.py",
      "position": 11,
      "tokens": 13861,
      "context_length": 102861
    },
    {
      "file_path": "django/contrib/admin/templatetags/admin_list.py",
      "position": 12,
      "tokens": 3829,
      "context_length": 106690
    },
    {
      "file_path": "django/db/models/sql/where.py",
      "position": 13,
      "tokens": 1804,
      "context_length": 108494
    },
    {
      "file_path": "django/db/backends/postgresql/features.py",
      "position": 14,
      "tokens": 674,
      "context_length": 109168
    },
    {
      "file_path": "django/db/backends/mysql/features.py",
      "position": 15,
      "tokens": 1325,
      "context_length": 110493
    },
    {
      "file_path": "django/db/backends/base/features.py",
      "position": 16,
      "tokens": 2594,
      "context_length": 113087
    },
    {
      "file_path": "django/contrib/postgres/fields/ranges.py",
      "position": 17,
      "tokens": 2117,
      "context_length": 115204
    },
    {
      "file_path": "django/db/backends/postgresql/introspection.py",
      "position": 18,
      "tokens": 2239,
      "context_length": 117443
    },
    {
      "file_path": "django/db/models/aggregates.py",
      "position": 19,
      "tokens": 1301,
      "context_length": 118744
    },
    {
      "file_path": "django/core/management/commands/inspectdb.py",
      "position": 20,
      "tokens": 2610,
      "context_length": 121354
    },
    {
      "file_path": "django/db/models/sql/subqueries.py",
      "position": 21,
      "tokens": 1213,
      "context_length": 122567
    },
    {
      "file_path": "django/db/models/sql/datastructures.py",
      "position": 22,
      "tokens": 1402,
      "context_length": 123969
    },
    {
      "file_path": "django/db/migrations/autodetector.py",
      "position": 23,
      "tokens": 11735,
      "context_length": 135704
    },
    {
      "file_path": "django/db/migrations/operations/models.py",
      "position": 24,
      "tokens": 6696,
      "context_length": 142400
    },
    {
      "file_path": "django/db/backends/mysql/operations.py",
      "position": 25,
      "tokens": 3331,
      "context_length": 145731
    },
    {
      "file_path": "django/db/backends/oracle/operations.py",
      "position": 26,
      "tokens": 5928,
      "context_length": 151659
    },
    {
      "file_path": "django/db/backends/sqlite3/operations.py",
      "position": 27,
      "tokens": 2896,
      "context_length": 154555
    },
    {
      "file_path": "django/db/models/deletion.py",
      "position": 28,
      "tokens": 3815,
      "context_length": 158370
    },
    {
      "file_path": "django/core/management/commands/squashmigrations.py",
      "position": 29,
      "tokens": 1871,
      "context_length": 160241
    },
    {
      "file_path": "django/contrib/postgres/search.py",
      "position": 30,
      "tokens": 1890,
      "context_length": 162131
    },
    {
      "file_path": "django/db/migrations/operations/base.py",
      "position": 31,
      "tokens": 1079,
      "context_length": 163210
    },
    {
      "file_path": "django/db/backends/base/operations.py",
      "position": 32,
      "tokens": 5580,
      "context_length": 168790
    },
    {
      "file_path": "django/views/i18n.py",
      "position": 33,
      "tokens": 2547,
      "context_length": 171337
    },
    {
      "file_path": "django/contrib/gis/db/models/lookups.py",
      "position": 34,
      "tokens": 2613,
      "context_length": 173950
    },
    {
      "file_path": "django/contrib/postgres/constraints.py",
      "position": 35,
      "tokens": 846,
      "context_length": 174796
    },
    {
      "file_path": "django/db/models/manager.py",
      "position": 36,
      "tokens": 1434,
      "context_length": 176230
    },
    {
      "file_path": "django/db/migrations/optimizer.py",
      "position": 37,
      "tokens": 596,
      "context_length": 176826
    },
    {
      "file_path": "django/contrib/postgres/aggregates/statistics.py",
      "position": 38,
      "tokens": 419,
      "context_length": 177245
    },
    {
      "file_path": "django/conf/locale/sr_Latn/formats.py",
      "position": 39,
      "tokens": 771,
      "context_length": 178016
    },
    {
      "file_path": "django/contrib/admin/options.py",
      "position": 40,
      "tokens": 18488,
      "context_length": 196504
    },
    {
      "file_path": "django/contrib/postgres/aggregates/mixins.py",
      "position": 41,
      "tokens": 442,
      "context_length": 196946
    },
    {
      "file_path": "django/conf/locale/sr/formats.py",
      "position": 42,
      "tokens": 771,
      "context_length": 197717
    },
    {
      "file_path": "django/contrib/gis/db/models/__init__.py",
      "position": 43,
      "tokens": 204,
      "context_length": 197921
    },
    {
      "file_path": "django/db/models/options.py",
      "position": 44,
      "tokens": 7096,
      "context_length": 205017
    }
  ]
}